<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP协议三次握手，四次挥手 | 扎星的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.205647b6.css" as="style"><link rel="preload" href="/assets/js/app.540bd70e.js" as="script"><link rel="preload" href="/assets/js/2.16ea11b0.js" as="script"><link rel="preload" href="/assets/js/11.27469b57.js" as="script"><link rel="prefetch" href="/assets/js/10.47b5ea20.js"><link rel="prefetch" href="/assets/js/12.5e356105.js"><link rel="prefetch" href="/assets/js/13.3061eb0b.js"><link rel="prefetch" href="/assets/js/14.b2f511fc.js"><link rel="prefetch" href="/assets/js/15.a30c374f.js"><link rel="prefetch" href="/assets/js/16.b7a2ff09.js"><link rel="prefetch" href="/assets/js/17.3dff6d49.js"><link rel="prefetch" href="/assets/js/18.e02730c9.js"><link rel="prefetch" href="/assets/js/19.7f97849f.js"><link rel="prefetch" href="/assets/js/20.9f9928ff.js"><link rel="prefetch" href="/assets/js/21.e8599ad7.js"><link rel="prefetch" href="/assets/js/22.097b89f1.js"><link rel="prefetch" href="/assets/js/23.01101d47.js"><link rel="prefetch" href="/assets/js/24.7d30419b.js"><link rel="prefetch" href="/assets/js/25.4eed8d5c.js"><link rel="prefetch" href="/assets/js/26.158ee697.js"><link rel="prefetch" href="/assets/js/27.e9170efa.js"><link rel="prefetch" href="/assets/js/28.7c8ef049.js"><link rel="prefetch" href="/assets/js/29.018ef9f3.js"><link rel="prefetch" href="/assets/js/3.8aab9c96.js"><link rel="prefetch" href="/assets/js/30.c6a87150.js"><link rel="prefetch" href="/assets/js/31.9a7b1b3e.js"><link rel="prefetch" href="/assets/js/32.c52e16c4.js"><link rel="prefetch" href="/assets/js/33.8dd3fd5e.js"><link rel="prefetch" href="/assets/js/34.beb451c6.js"><link rel="prefetch" href="/assets/js/35.91c649e5.js"><link rel="prefetch" href="/assets/js/36.128f9a44.js"><link rel="prefetch" href="/assets/js/37.17a67f38.js"><link rel="prefetch" href="/assets/js/38.068477d4.js"><link rel="prefetch" href="/assets/js/39.bdba62cc.js"><link rel="prefetch" href="/assets/js/4.2cba2aae.js"><link rel="prefetch" href="/assets/js/40.67e2884d.js"><link rel="prefetch" href="/assets/js/41.91a5b7e5.js"><link rel="prefetch" href="/assets/js/42.8f151f55.js"><link rel="prefetch" href="/assets/js/43.f3213f67.js"><link rel="prefetch" href="/assets/js/44.6462e566.js"><link rel="prefetch" href="/assets/js/45.5246e027.js"><link rel="prefetch" href="/assets/js/46.22bbff70.js"><link rel="prefetch" href="/assets/js/47.ef4f70f2.js"><link rel="prefetch" href="/assets/js/48.536f2a12.js"><link rel="prefetch" href="/assets/js/49.404bd2af.js"><link rel="prefetch" href="/assets/js/5.d006dfce.js"><link rel="prefetch" href="/assets/js/50.0230797f.js"><link rel="prefetch" href="/assets/js/51.08d61a87.js"><link rel="prefetch" href="/assets/js/52.aa64387e.js"><link rel="prefetch" href="/assets/js/53.596238be.js"><link rel="prefetch" href="/assets/js/54.ecf7c0a7.js"><link rel="prefetch" href="/assets/js/55.9b6cf76b.js"><link rel="prefetch" href="/assets/js/56.a5f87165.js"><link rel="prefetch" href="/assets/js/57.48ee0a85.js"><link rel="prefetch" href="/assets/js/58.85b15902.js"><link rel="prefetch" href="/assets/js/59.ee5fe2cb.js"><link rel="prefetch" href="/assets/js/6.231c4f94.js"><link rel="prefetch" href="/assets/js/60.6eb7d76e.js"><link rel="prefetch" href="/assets/js/61.b4fc41f6.js"><link rel="prefetch" href="/assets/js/62.6d3b07d3.js"><link rel="prefetch" href="/assets/js/63.7af919ee.js"><link rel="prefetch" href="/assets/js/64.e5f3d9d8.js"><link rel="prefetch" href="/assets/js/65.a8f61562.js"><link rel="prefetch" href="/assets/js/66.85a3e853.js"><link rel="prefetch" href="/assets/js/67.fd0801cc.js"><link rel="prefetch" href="/assets/js/68.65ef5af6.js"><link rel="prefetch" href="/assets/js/69.b408a555.js"><link rel="prefetch" href="/assets/js/7.2c7770b3.js"><link rel="prefetch" href="/assets/js/70.3657aab6.js"><link rel="prefetch" href="/assets/js/71.bcf5ba4a.js"><link rel="prefetch" href="/assets/js/72.cb446fcf.js"><link rel="prefetch" href="/assets/js/73.7f7e3f3e.js"><link rel="prefetch" href="/assets/js/74.72601955.js"><link rel="prefetch" href="/assets/js/75.14941226.js"><link rel="prefetch" href="/assets/js/76.b82b9ea5.js"><link rel="prefetch" href="/assets/js/77.13f3d0f3.js"><link rel="prefetch" href="/assets/js/78.e9ff42ff.js"><link rel="prefetch" href="/assets/js/79.6d3aa24c.js"><link rel="prefetch" href="/assets/js/8.748c4bee.js"><link rel="prefetch" href="/assets/js/80.33b641a9.js"><link rel="prefetch" href="/assets/js/81.bdd447dc.js"><link rel="prefetch" href="/assets/js/82.330d942e.js"><link rel="prefetch" href="/assets/js/83.99b28c32.js"><link rel="prefetch" href="/assets/js/84.c9800578.js"><link rel="prefetch" href="/assets/js/85.34939246.js"><link rel="prefetch" href="/assets/js/86.98973baa.js"><link rel="prefetch" href="/assets/js/87.c1f1cbef.js"><link rel="prefetch" href="/assets/js/88.ebf94fb9.js"><link rel="prefetch" href="/assets/js/89.fc51b01d.js"><link rel="prefetch" href="/assets/js/9.10e80d90.js"><link rel="prefetch" href="/assets/js/90.bdb814fd.js"><link rel="prefetch" href="/assets/js/91.67991eea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.205647b6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">扎星的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS编程练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>V8引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步I/O和异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>TCP协议</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/networkprotocol/tcp/001/" class="sidebar-link">TCP和UDP协议概述</a></li><li><a href="/networkprotocol/tcp/002/" aria-current="page" class="active sidebar-link">三次握手四次挥手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#tcp位码" class="sidebar-link">TCP位码</a></li><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#三次握手-客户端主动打开" class="sidebar-link">三次握手（客户端主动打开）</a></li><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#四次挥手-客户端、服务端均可主动关闭" class="sidebar-link">四次挥手（客户端、服务端均可主动关闭）</a></li><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#在tcp三次握手中-为什么客户端最后还要发送一次确认呢-为什么不是两次" class="sidebar-link">在TCP三次握手中，为什么客户端最后还要发送一次确认呢？（为什么不是两次）</a></li><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#三次握手过程中可以携带数据么" class="sidebar-link">三次握手过程中可以携带数据么？</a></li><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#在tcp四次挥手中的第三挥手服务端为什么不直接释放连接-而是要先确认一次第二次才释放" class="sidebar-link">在TCP四次挥手中的第三挥手服务端为什么不直接释放连接，而是要先确认一次第二次才释放？</a></li><li class="sidebar-sub-header"><a href="/networkprotocol/tcp/002/#在tcp四次挥手中的第四次挥手之后-客户端a为什么还要等待-2msl-的时间" class="sidebar-link">在TCP四次挥手中的第四次挥手之后，客户端A为什么还要等待 2MSL 的时间？</a></li></ul></li><li><a href="/networkprotocol/tcp/003/" class="sidebar-link">半连接队列和 SYN Flood 攻击是什么关系？</a></li><li><a href="/networkprotocol/tcp/004/" class="sidebar-link">TCP 报文头部的字段介绍</a></li><li><a href="/networkprotocol/tcp/005/" class="sidebar-link">谈谈 TCP 快速打开的原理(TFO)</a></li><li><a href="/networkprotocol/tcp/006/" class="sidebar-link">TCP报文中的时间戳的作用</a></li><li><a href="/networkprotocol/tcp/007/" class="sidebar-link">TCP流量控制</a></li><li><a href="/networkprotocol/tcp/008/" class="sidebar-link">TCP拥塞控制</a></li><li><a href="/networkprotocol/tcp/009/" class="sidebar-link">Negle 算法和延迟确认</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp协议三次握手-四次挥手"><a href="#tcp协议三次握手-四次挥手" class="header-anchor">#</a> TCP协议三次握手，四次挥手</h1> <h2 id="tcp位码"><a href="#tcp位码" class="header-anchor">#</a> TCP位码</h2> <ul><li><p>SYN，同步位，表示是否建立连接</p></li> <li><p>FIN，终止位，表示是否关闭连接</p></li> <li><p>ACK，确认位，表示响应，确认接收到了相应序号的数据包</p></li> <li><p>seq 是自己数据包本身的序号；ack是期望对方继续发送的那个数据包的序号。</p></li> <li><p>MSL是Maximum Segment Lifetime英文的缩写，中文可以译为“报文最大生存时间”，他是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃</p></li></ul> <p>TCP 报文段示意图：</p> <p><img src="/assets/img/3.6fc2f9a4.jpg" alt="3"></p> <h2 id="三次握手-客户端主动打开"><a href="#三次握手-客户端主动打开" class="header-anchor">#</a> 三次握手（客户端主动打开）</h2> <p><img src="/assets/img/1.57062942.png" alt="1"></p> <p>三次握手：由客户端A主动打开连接请求连接服务端B，代表运输连接的三个阶段：连接建立、数据传送、连接释放。</p> <ol><li><p>A 发送 SYN = 1，seq = x；表示客户端 A 发送 SYN 信号请求与服务端 B 握手同步，同时选择一个初始序号 x（随机的序号）</p></li> <li><p>B 接受到 A 的连接请求报文，发送 SYN = 1，ACK = 1，seq = y，ack = x+1；表示服务端同意建立连接，把 SYN 位和 ACK 位都置 1，发送确认号 ack = seq + 1  = x + 1, 同时为自己也选择一个初始序号 seq = y（随机的序号）</p></li> <li><p>A 接受到 B 的确认报文，发送 ACK = 1，ack = y+1，seq = x+1，TCP 客户A 收到 B 的确认后，还要向 B 给出确认，ACK 位置 1，携带自己的序号 seq = x + 1, 确认 B 的序列号，ack = y + 1</p></li></ol> <p></p> <p>TCP 规定 SYN 报文段即使不携带数据，但是要消耗掉一个序号</p> <h2 id="四次挥手-客户端、服务端均可主动关闭"><a href="#四次挥手-客户端、服务端均可主动关闭" class="header-anchor">#</a> 四次挥手（客户端、服务端均可主动关闭）</h2> <p><img src="/assets/img/2.791da1b4.png" alt="2"></p> <p>数据传输结束后，通信的双方都可以释放连接。这里假设客户端主动发起关闭请求。</p> <p>第一次挥手：客户端发送终止报文，报文中把 FIN 置1，seq=u（已传送过的数据最后一个字节序号+1），传送给服务端，客户端进入中止等待1状态(FIN-WAIT-1)。 客户端主动发起终止连接的报文，并发送自己当前的序列号，然后开始等待 B 的确认。</p> <p>第二次挥手：服务端发送确认报文，报文中把 ACK 置1，seq=v，ack=u+1给客户端，客户端进入中止等待2状态（FIN-WAIT-2），服务器进入关闭等待状态 close-wait。服务端 B 此时确认收到客户端 A 发送的终止报文，此时的 TCP 连接处于半关闭状态，即 A 已经没有数据要发送了，但是此时如果 B 若发送数据，A 仍要接收。</p> <p>第三次挥手：服务端确认没有消息要发送后，最终发送终止确认报文。报文中 FIN=1，ACK=1, seq=w, ack=u+1，w 有可能等于 v 也有可能大于 v，取决于 B 在确认与终止之间是否又发送了一些数据。</p> <p>第四次挥手：客户端发送确认报文 ACK=1，seq=u+1, ack=w+1 发送给服务器，服务器收到 ACK 报文段后立即关闭，客户端等待2MSL时间后关闭。</p> <p></p> <p>TCP 规定 FIN 报文段即使不携带数据，也要消耗掉一个序号。(凡是需要对端确认的，一定消耗TCP报文的序列号。SYN 需要对端的确认， 而 ACK 并不需要，因此 SYN 消耗一个序列号而 ACK 不需要。FIN 报文段同理)</p> <h2 id="在tcp三次握手中-为什么客户端最后还要发送一次确认呢-为什么不是两次"><a href="#在tcp三次握手中-为什么客户端最后还要发送一次确认呢-为什么不是两次" class="header-anchor">#</a> 在TCP三次握手中，为什么客户端最后还要发送一次确认呢？（为什么不是两次）</h2> <p>根本原因: 无法确认客户端的接收能力。</p> <p>分析如下:</p> <p>如果是两次，你现在发了 SYN 报文想握手，但是这个包滞留在了当前的网络中迟迟没有到达，TCP 以为这是丢了包，于是重传，两次握手建立好了连接。</p> <p>看似没有问题，但是连接关闭后，如果这个滞留在网路中的包到达了服务端呢？这时候由于是两次握手，服务端只要接收到然后发送相应的数据包，就默认建立连接，但是现在客户端已经断开了。</p> <p>看到问题的吧，这就带来了连接资源的浪费。</p> <h2 id="三次握手过程中可以携带数据么"><a href="#三次握手过程中可以携带数据么" class="header-anchor">#</a> 三次握手过程中可以携带数据么？</h2> <p>第三次握手的时候，可以携带。前两次握手不能携带数据。</p> <p>如果前两次握手能够携带数据，那么一旦有人想攻击服务器，那么他只需要在第一次握手中的 SYN 报文中放大量数据，那么服务器势必会消耗更多的时间和内存空间去处理这些数据，增大了服务器被攻击的风险。</p> <p>第三次握手的时候，客户端已经处于ESTABLISHED状态，并且已经能够确认服务器的接收、发送能力正常，这个时候相对安全了，可以携带数据。</p> <h2 id="在tcp四次挥手中的第三挥手服务端为什么不直接释放连接-而是要先确认一次第二次才释放"><a href="#在tcp四次挥手中的第三挥手服务端为什么不直接释放连接-而是要先确认一次第二次才释放" class="header-anchor">#</a> 在TCP四次挥手中的第三挥手服务端为什么不直接释放连接，而是要先确认一次第二次才释放？</h2> <p>因为服务端在接收到FIN, 往往不会立即返回FIN, 必须等到服务端所有的报文都发送完毕了，才能发FIN。因此先发一个ACK表示已经收到客户端的FIN，延迟一段时间才发FIN。这就造成了四次挥手。</p> <p>如果是三次挥手会有什么问题？</p> <p>等于说服务端将ACK和FIN的发送合并为一次挥手，这个时候长时间的延迟可能会导致客户端误以为FIN没有到达客户端，从而让客户端不断的重发FIN。</p> <h2 id="在tcp四次挥手中的第四次挥手之后-客户端a为什么还要等待-2msl-的时间"><a href="#在tcp四次挥手中的第四次挥手之后-客户端a为什么还要等待-2msl-的时间" class="header-anchor">#</a> 在TCP四次挥手中的第四次挥手之后，客户端A为什么还要等待 2MSL 的时间？</h2> <p>如果不等待，客户端直接跑路，当服务端还有很多数据包要给客户端发，且还在路上的时候，若客户端的端口此时刚好被新的应用占用，那么就接收到了无用数据包，造成数据包混乱。所以，最保险的做法是等服务器发来的数据包都死翘翘再启动新的应用。</p> <p>那，照这样说一个 MSL 不就不够了吗，为什么要等待 2 MSL?</p> <p>1 个 MSL 确保四次挥手中主动关闭方最后的 ACK 报文最终能达到对端
1 个 MSL 确保对端没有收到 ACK 重传的 FIN 报文可以到达
这就是等待 2MSL 的意义。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/networkprotocol/tcp/001/" class="prev">
        TCP和UDP协议概述
      </a></span> <span class="next"><a href="/networkprotocol/tcp/003/">
        半连接队列和 SYN Flood 攻击是什么关系？
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.540bd70e.js" defer></script><script src="/assets/js/2.16ea11b0.js" defer></script><script src="/assets/js/11.27469b57.js" defer></script>
  </body>
</html>
