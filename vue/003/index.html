<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>响应式系统的依赖收集追踪原理 | 扎星的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.8c09bca5.css" as="style"><link rel="preload" href="/assets/js/app.68bcc21e.js" as="script"><link rel="preload" href="/assets/js/2.df3e4849.js" as="script"><link rel="preload" href="/assets/js/25.fb2c18c6.js" as="script"><link rel="prefetch" href="/assets/js/10.4fa21d0c.js"><link rel="prefetch" href="/assets/js/100.a7c67571.js"><link rel="prefetch" href="/assets/js/101.1ce6d8ee.js"><link rel="prefetch" href="/assets/js/102.4fef5e7e.js"><link rel="prefetch" href="/assets/js/103.158a9ff8.js"><link rel="prefetch" href="/assets/js/104.abb10eb9.js"><link rel="prefetch" href="/assets/js/105.5fdc4925.js"><link rel="prefetch" href="/assets/js/106.b42f4dbc.js"><link rel="prefetch" href="/assets/js/107.7c64c79b.js"><link rel="prefetch" href="/assets/js/108.065bda7a.js"><link rel="prefetch" href="/assets/js/109.6ff6c8b4.js"><link rel="prefetch" href="/assets/js/11.8c76a1bf.js"><link rel="prefetch" href="/assets/js/110.5031e466.js"><link rel="prefetch" href="/assets/js/111.c62a65c6.js"><link rel="prefetch" href="/assets/js/112.fe19b95a.js"><link rel="prefetch" href="/assets/js/113.8c1b858c.js"><link rel="prefetch" href="/assets/js/114.f7082016.js"><link rel="prefetch" href="/assets/js/115.05c28e87.js"><link rel="prefetch" href="/assets/js/116.aae9e290.js"><link rel="prefetch" href="/assets/js/117.80ee2176.js"><link rel="prefetch" href="/assets/js/118.478b97d1.js"><link rel="prefetch" href="/assets/js/119.7e651dde.js"><link rel="prefetch" href="/assets/js/12.0fe079dd.js"><link rel="prefetch" href="/assets/js/120.8917b0a2.js"><link rel="prefetch" href="/assets/js/121.f81b04eb.js"><link rel="prefetch" href="/assets/js/122.3b92d0e6.js"><link rel="prefetch" href="/assets/js/123.901faf89.js"><link rel="prefetch" href="/assets/js/13.aa6c0f0b.js"><link rel="prefetch" href="/assets/js/14.6cd57988.js"><link rel="prefetch" href="/assets/js/15.cbd6c92e.js"><link rel="prefetch" href="/assets/js/16.ce5b7f5e.js"><link rel="prefetch" href="/assets/js/17.77028844.js"><link rel="prefetch" href="/assets/js/18.900f2272.js"><link rel="prefetch" href="/assets/js/19.6bdd95eb.js"><link rel="prefetch" href="/assets/js/20.1d092af7.js"><link rel="prefetch" href="/assets/js/21.8b6e0eae.js"><link rel="prefetch" href="/assets/js/22.4f313d8a.js"><link rel="prefetch" href="/assets/js/23.c1a9a180.js"><link rel="prefetch" href="/assets/js/24.47c045fe.js"><link rel="prefetch" href="/assets/js/26.58af4147.js"><link rel="prefetch" href="/assets/js/27.49ad2c7b.js"><link rel="prefetch" href="/assets/js/28.6586a2a9.js"><link rel="prefetch" href="/assets/js/29.38405dba.js"><link rel="prefetch" href="/assets/js/3.718626c9.js"><link rel="prefetch" href="/assets/js/30.7f0d22d8.js"><link rel="prefetch" href="/assets/js/31.63280a59.js"><link rel="prefetch" href="/assets/js/32.c3a00710.js"><link rel="prefetch" href="/assets/js/33.5cd6d28a.js"><link rel="prefetch" href="/assets/js/34.5fb6be8b.js"><link rel="prefetch" href="/assets/js/35.31c6b0e4.js"><link rel="prefetch" href="/assets/js/36.44832f43.js"><link rel="prefetch" href="/assets/js/37.0d0e163f.js"><link rel="prefetch" href="/assets/js/38.eb0daf3f.js"><link rel="prefetch" href="/assets/js/39.dc48dc9c.js"><link rel="prefetch" href="/assets/js/4.dc0b9889.js"><link rel="prefetch" href="/assets/js/40.274b3aaf.js"><link rel="prefetch" href="/assets/js/41.f23c843f.js"><link rel="prefetch" href="/assets/js/42.9d7c4e81.js"><link rel="prefetch" href="/assets/js/43.62fde47e.js"><link rel="prefetch" href="/assets/js/44.f219cc85.js"><link rel="prefetch" href="/assets/js/45.ff5f4257.js"><link rel="prefetch" href="/assets/js/46.cd087c62.js"><link rel="prefetch" href="/assets/js/47.976408d6.js"><link rel="prefetch" href="/assets/js/48.32d1676e.js"><link rel="prefetch" href="/assets/js/49.f10f00cc.js"><link rel="prefetch" href="/assets/js/5.a372d006.js"><link rel="prefetch" href="/assets/js/50.6e2ae914.js"><link rel="prefetch" href="/assets/js/51.e608ad23.js"><link rel="prefetch" href="/assets/js/52.0d85cc42.js"><link rel="prefetch" href="/assets/js/53.e84a148a.js"><link rel="prefetch" href="/assets/js/54.7b3a2cf5.js"><link rel="prefetch" href="/assets/js/55.8dab2075.js"><link rel="prefetch" href="/assets/js/56.ba6abf70.js"><link rel="prefetch" href="/assets/js/57.ac0ae7af.js"><link rel="prefetch" href="/assets/js/58.ad2bc8e9.js"><link rel="prefetch" href="/assets/js/59.407b1d32.js"><link rel="prefetch" href="/assets/js/6.b9f5be84.js"><link rel="prefetch" href="/assets/js/60.eb0640b0.js"><link rel="prefetch" href="/assets/js/61.208195c0.js"><link rel="prefetch" href="/assets/js/62.78df72ec.js"><link rel="prefetch" href="/assets/js/63.34fb985b.js"><link rel="prefetch" href="/assets/js/64.6493e093.js"><link rel="prefetch" href="/assets/js/65.4a3dcc42.js"><link rel="prefetch" href="/assets/js/66.5de6b57e.js"><link rel="prefetch" href="/assets/js/67.24bade72.js"><link rel="prefetch" href="/assets/js/68.2248a782.js"><link rel="prefetch" href="/assets/js/69.24e6542e.js"><link rel="prefetch" href="/assets/js/7.12962e86.js"><link rel="prefetch" href="/assets/js/70.cf80b6cd.js"><link rel="prefetch" href="/assets/js/71.08631771.js"><link rel="prefetch" href="/assets/js/72.460992a6.js"><link rel="prefetch" href="/assets/js/73.4d0c13f1.js"><link rel="prefetch" href="/assets/js/74.c1a08907.js"><link rel="prefetch" href="/assets/js/75.644a7a6d.js"><link rel="prefetch" href="/assets/js/76.286d685f.js"><link rel="prefetch" href="/assets/js/77.201dda5d.js"><link rel="prefetch" href="/assets/js/78.7ad2fea8.js"><link rel="prefetch" href="/assets/js/79.51b5b503.js"><link rel="prefetch" href="/assets/js/8.791cc050.js"><link rel="prefetch" href="/assets/js/80.3013288f.js"><link rel="prefetch" href="/assets/js/81.c1429b0d.js"><link rel="prefetch" href="/assets/js/82.2418f558.js"><link rel="prefetch" href="/assets/js/83.83768632.js"><link rel="prefetch" href="/assets/js/84.b7a28c02.js"><link rel="prefetch" href="/assets/js/85.e36b7c1a.js"><link rel="prefetch" href="/assets/js/86.a0409766.js"><link rel="prefetch" href="/assets/js/87.74c389b7.js"><link rel="prefetch" href="/assets/js/88.42297d4a.js"><link rel="prefetch" href="/assets/js/89.e652a303.js"><link rel="prefetch" href="/assets/js/9.142b36f8.js"><link rel="prefetch" href="/assets/js/90.3083df1b.js"><link rel="prefetch" href="/assets/js/91.940264f1.js"><link rel="prefetch" href="/assets/js/92.84f64336.js"><link rel="prefetch" href="/assets/js/93.80519c0b.js"><link rel="prefetch" href="/assets/js/94.ef254a74.js"><link rel="prefetch" href="/assets/js/95.45aeaf31.js"><link rel="prefetch" href="/assets/js/96.c3814197.js"><link rel="prefetch" href="/assets/js/97.4b92b66f.js"><link rel="prefetch" href="/assets/js/98.a907ea9d.js"><link rel="prefetch" href="/assets/js/99.f2c0dde8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c09bca5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">扎星的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS编程练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS常见设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS高阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>V8引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步I/O和异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TCP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/001/" class="sidebar-link">Vue.js 运行机制全局概览</a></li><li><a href="/vue/002/" class="sidebar-link">响应式系统的基本原理</a></li><li><a href="/vue/003/" aria-current="page" class="active sidebar-link">响应式系统的依赖收集追踪原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/003/#为什么要依赖收集" class="sidebar-link">为什么要依赖收集？</a></li><li class="sidebar-sub-header"><a href="/vue/003/#订阅者-dep" class="sidebar-link">订阅者 Dep</a></li><li class="sidebar-sub-header"><a href="/vue/003/#观察者-watcher" class="sidebar-link">观察者 Watcher</a></li><li class="sidebar-sub-header"><a href="/vue/003/#依赖收集" class="sidebar-link">依赖收集</a></li><li class="sidebar-sub-header"><a href="/vue/003/#完整代码" class="sidebar-link">完整代码</a></li><li class="sidebar-sub-header"><a href="/vue/003/#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/vue/004/" class="sidebar-link">实现 Virtual DOM 下的一个 VNode 节点</a></li><li><a href="/vue/005/" class="sidebar-link">template 模板是怎样通过 Compile 编译的</a></li><li><a href="/vue/006/" class="sidebar-link">数据状态更新时的差异 diff 及 patch 机制</a></li><li><a href="/vue/007/" class="sidebar-link">批量异步更新策略及 nextTick 原理</a></li><li><a href="/vue/008/" class="sidebar-link">Vuex 状态管理的工作原理</a></li><li><a href="/vue/009/" class="sidebar-link">Vue3 Diff算法</a></li><li><a href="/vue/010/" class="sidebar-link">Vue3 响应式原理</a></li><li><a href="/vue/011/" class="sidebar-link">Vue2/3 响应式对数组的处理</a></li><li><a href="/vue/012/" class="sidebar-link">012 手写 Vuex 核心原理</a></li><li><a href="/vue/013/" class="sidebar-link">013 v-model 语法糖</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="响应式系统的依赖收集追踪原理"><a href="#响应式系统的依赖收集追踪原理" class="header-anchor">#</a> 响应式系统的依赖收集追踪原理</h1> <h2 id="为什么要依赖收集"><a href="#为什么要依赖收集" class="header-anchor">#</a> 为什么要依赖收集？</h2> <h3 id="先举个栗子🌰"><a href="#先举个栗子🌰" class="header-anchor">#</a> 先举个栗子🌰</h3> <p>我们现在有这么一个 Vue 对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token operator">:</span> 
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
            &lt;span&gt;{{text1}}&lt;/span&gt; 
            &lt;span&gt;{{text2}}&lt;/span&gt; 
        &lt;div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
        text1<span class="token operator">:</span> <span class="token string">'text1'</span><span class="token punctuation">,</span>
        text2<span class="token operator">:</span> <span class="token string">'text2'</span><span class="token punctuation">,</span>
        text3<span class="token operator">:</span> <span class="token string">'text3'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后我们做了这么一个操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>text3 <span class="token operator">=</span> <span class="token string">'modify text3'</span><span class="token punctuation">;</span>
</code></pre></div><p>我们修改了 data 中 text3 的数据，但是因为视图中并不需要用到 text3 ，所以我们并不需要触发上一章所讲的 cb 函数来更新视图，调用 cb 显然是不正确的。</p> <h3 id="再来一个栗子🌰"><a href="#再来一个栗子🌰" class="header-anchor">#</a> 再来一个栗子🌰</h3> <p>假设我们现在有一个全局的对象，我们可能会在多个 Vue 对象中用到它进行展示。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> globalObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    text1<span class="token operator">:</span> <span class="token string">'text1'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token operator">:</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
            &lt;span&gt;{{text1}}&lt;/span&gt; 
        &lt;div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> globalObj
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token operator">:</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
            &lt;span&gt;{{text1}}&lt;/span&gt; 
        &lt;div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> globalObj
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个时候，我们执行了如下操作。</p> <div class="language-js extra-class"><pre class="language-js"><code>globalObj<span class="token punctuation">.</span>text1 <span class="token operator">=</span> <span class="token string">'hello,text1'</span><span class="token punctuation">;</span>
</code></pre></div><p>我们应该需要通知 o1 以及 o2 两个vm实例进行视图的更新，「依赖收集」会让 text1 这个数据知道“哦～有两个地方依赖我的数据，我变化的时候需要通知它们～”。</p> <p>最终会形成数据与视图的一种对应关系，如下图。</p> <p><img src="data:image/jpeg;base64,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" alt="1"></p> <p>接下来我们来介绍一下「依赖收集」是如何实现的。</p> <h2 id="订阅者-dep"><a href="#订阅者-dep" class="header-anchor">#</a> 订阅者 Dep</h2> <p>首先我们来实现一个订阅者 Dep ，它的主要作用是用来存放 Watcher 观察者对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 用来存放Watcher对象的数组 */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 在subs中添加一个Watcher对象 */</span>
    <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 通知所有Watcher对象更新视图 */</span>
    <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了便于理解我们只实现了添加的部分代码，主要是两件事情：</p> <ol><li><p>用 addSub 方法可以在目前的 Dep 对象中增加一个 Watcher 的订阅操作；</p></li> <li><p>用 notify 方法通知目前 Dep 对象的 subs 中的所有 Watcher 对象触发更新操作。</p></li></ol> <h2 id="观察者-watcher"><a href="#观察者-watcher" class="header-anchor">#</a> 观察者 Watcher</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 在new一个Watcher对象时将该对象赋值给Dep.target，在get中会用到 */</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 更新视图的方法 */</span>
    <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;视图更新啦～&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="依赖收集"><a href="#依赖收集" class="header-anchor">#</a> 依赖收集</h2> <p>接下来我们修改一下 defineReactive 以及 Vue 的构造函数，来完成依赖收集。</p> <p>我们在闭包中增加了一个 Dep 类的对象，用来收集 Watcher 对象。在对象被「读」的时候，会触发 reactiveGetter 函数把当前的 Watcher 对象（存放在 Dep.target 中）收集到 Dep 类中去。之后如果当该对象被「写」的时候，则会触发 reactiveSetter 方法，通知 Dep 类调用 notify 来触发所有 Watcher 对象的 update 方法更新对应视图。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 一个Dep类对象 */</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* 将Dep.target（即当前的Watcher对象存入dep的subs中） */</span>
            dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> val<span class="token punctuation">;</span>         
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">/* 在set的时候触发dep的notify来通知所有的Watcher对象更新视图 */</span>
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_data <span class="token operator">=</span> options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 新建一个Watcher观察者对象，这时候Dep.target会指向这个Watcher对象 */</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 在这里模拟render的过程，为了触发test属性的get函数 */</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render~'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h2> <p>部分代码有调整：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用来存放 Watcher 对象的数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 在 subs 中添加一个 Watcher 对象</span>
  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 通知所有的 Watcher 对象更新视图</span>
  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// new Watcher 对象的时候，把该对象赋值给 Dep.target, 在 get 中会用到</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>obj <span class="token operator">=</span> obj
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// 触发 defineProperty 的 get 方法</span>

    <span class="token comment">// Dep 添加 watcher 完成</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span> 
  <span class="token punctuation">}</span>

  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>obj<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">]</span>
      
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 可以把他理解为一个全局变量</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 一个 Dep 类对象</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 属性可枚举</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 属性可修改或者删除</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">/* 将Dep.target（即当前的Watcher对象存入dep的subs中） */</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      val <span class="token operator">=</span> newVal
       <span class="token comment">/* 在set的时候触发dep的notify来通知所有的Watcher对象更新视图 */</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">observer</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_data <span class="token operator">=</span> options<span class="token punctuation">.</span>data
    <span class="token function">observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">)</span>

    <span class="token comment">/* 新建一个Watcher观察者对象，这时候Dep.target会指向这个Watcher对象 */</span>
    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'test 视图更新啦'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">/* 在这里模拟render的过程，为了触发test属性的 set 函数 */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token string">'abc'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> vue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token string">&quot;I am test.&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>总结一下。</p> <p>首先在 observer 的过程中会注册 get 方法，该方法用来进行「依赖收集」。在它的闭包中会有一个 Dep 对象，这个对象用来存放 Watcher 对象的实例。其实「依赖收集」的过程就是把 Watcher 实例存放到对应的 Dep 对象中去。get 方法可以让当前的 Watcher 对象（Dep.target）存放到它的 subs 中（addSub）方法，在数据变化时，set 会调用 Dep 对象的 notify 方法通知它内部所有的 Watcher 对象进行视图更新。</p> <p>这是 Object.defineProperty 的 set/get 方法处理的事情，那么「依赖收集」的前提条件还有两个：</p> <ol><li><p>触发 get 方法；</p></li> <li><p>新建一个 Watcher 对象。</p></li></ol> <p>这个我们在 Vue 的构造类中处理。新建一个 Watcher 对象只需要 new 出来，这时候 Dep.target 已经指向了这个 new 出来的 Watcher 对象来。而触发 get 方法也很简单，实际上只要把 render function 进行渲染，那么其中的依赖的对象都会被「读取」，这里我们通过打印来模拟这个过程，读取 test 来触发 get 进行「依赖收集」。</p> <p>本章我们介绍了「依赖收集」的过程，配合之前的响应式原理，已经把整个「响应式系统」介绍完毕了。其主要就是 get 进行「依赖收集」。set 通过观察者来更新视图，配合下图仔细捋一捋，相信一定能搞懂它！</p> <p><img src="/assets/img/2.e368f6a8.jpg" alt="2"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue/002/" class="prev">
        响应式系统的基本原理
      </a></span> <span class="next"><a href="/vue/004/">
        实现 Virtual DOM 下的一个 VNode 节点
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.68bcc21e.js" defer></script><script src="/assets/js/2.df3e4849.js" defer></script><script src="/assets/js/25.fb2c18c6.js" defer></script>
  </body>
</html>
