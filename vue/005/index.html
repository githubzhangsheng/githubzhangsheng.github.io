<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>template 模板是怎样通过 Compile 编译的 | 扎星的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.b0fbd704.css" as="style"><link rel="preload" href="/assets/js/app.7faaeb90.js" as="script"><link rel="preload" href="/assets/js/2.4ceac094.js" as="script"><link rel="preload" href="/assets/js/1.06e97743.js" as="script"><link rel="preload" href="/assets/js/23.4cc8500e.js" as="script"><link rel="prefetch" href="/assets/js/10.4d67db37.js"><link rel="prefetch" href="/assets/js/100.9ada27ad.js"><link rel="prefetch" href="/assets/js/101.7eccfd40.js"><link rel="prefetch" href="/assets/js/102.e344b695.js"><link rel="prefetch" href="/assets/js/103.b91c2e2b.js"><link rel="prefetch" href="/assets/js/104.6f90f799.js"><link rel="prefetch" href="/assets/js/105.73780a6e.js"><link rel="prefetch" href="/assets/js/106.e8737813.js"><link rel="prefetch" href="/assets/js/107.5f785c2c.js"><link rel="prefetch" href="/assets/js/108.74958d5b.js"><link rel="prefetch" href="/assets/js/109.d3005515.js"><link rel="prefetch" href="/assets/js/11.32340e89.js"><link rel="prefetch" href="/assets/js/110.65860f7f.js"><link rel="prefetch" href="/assets/js/111.d91c32b6.js"><link rel="prefetch" href="/assets/js/112.a5e8efc2.js"><link rel="prefetch" href="/assets/js/113.191ff9e1.js"><link rel="prefetch" href="/assets/js/114.eb21d1d8.js"><link rel="prefetch" href="/assets/js/115.ed058567.js"><link rel="prefetch" href="/assets/js/116.c73d4a79.js"><link rel="prefetch" href="/assets/js/117.c1195019.js"><link rel="prefetch" href="/assets/js/118.b2aeca16.js"><link rel="prefetch" href="/assets/js/119.666dc6c6.js"><link rel="prefetch" href="/assets/js/12.f3209147.js"><link rel="prefetch" href="/assets/js/120.548bb39a.js"><link rel="prefetch" href="/assets/js/121.d6368bb6.js"><link rel="prefetch" href="/assets/js/122.14d59fae.js"><link rel="prefetch" href="/assets/js/123.7e5e4cc0.js"><link rel="prefetch" href="/assets/js/124.a9c9fc37.js"><link rel="prefetch" href="/assets/js/125.2de4a8c4.js"><link rel="prefetch" href="/assets/js/126.6d029a58.js"><link rel="prefetch" href="/assets/js/127.3f37c3d9.js"><link rel="prefetch" href="/assets/js/128.3bab5bc7.js"><link rel="prefetch" href="/assets/js/129.fde4fcbb.js"><link rel="prefetch" href="/assets/js/13.ff905545.js"><link rel="prefetch" href="/assets/js/130.21002715.js"><link rel="prefetch" href="/assets/js/131.e261ff32.js"><link rel="prefetch" href="/assets/js/132.f4df11c1.js"><link rel="prefetch" href="/assets/js/133.3082ed5c.js"><link rel="prefetch" href="/assets/js/134.f583893d.js"><link rel="prefetch" href="/assets/js/135.4930a3bf.js"><link rel="prefetch" href="/assets/js/136.088fe073.js"><link rel="prefetch" href="/assets/js/137.3b78020c.js"><link rel="prefetch" href="/assets/js/138.19b200da.js"><link rel="prefetch" href="/assets/js/139.890d6075.js"><link rel="prefetch" href="/assets/js/14.c3568dfc.js"><link rel="prefetch" href="/assets/js/140.5b795da9.js"><link rel="prefetch" href="/assets/js/141.15c2c5e7.js"><link rel="prefetch" href="/assets/js/142.c336f1c2.js"><link rel="prefetch" href="/assets/js/143.0eba62e9.js"><link rel="prefetch" href="/assets/js/144.556773e6.js"><link rel="prefetch" href="/assets/js/15.7af482c3.js"><link rel="prefetch" href="/assets/js/16.1add91f2.js"><link rel="prefetch" href="/assets/js/17.5211db13.js"><link rel="prefetch" href="/assets/js/18.cb58294e.js"><link rel="prefetch" href="/assets/js/19.3f4c86e4.js"><link rel="prefetch" href="/assets/js/20.f6e9413a.js"><link rel="prefetch" href="/assets/js/21.d3127fc5.js"><link rel="prefetch" href="/assets/js/22.75a3675d.js"><link rel="prefetch" href="/assets/js/24.6e9f6fde.js"><link rel="prefetch" href="/assets/js/25.59ab9b92.js"><link rel="prefetch" href="/assets/js/26.b6ea8fe3.js"><link rel="prefetch" href="/assets/js/27.eb622419.js"><link rel="prefetch" href="/assets/js/28.82216df1.js"><link rel="prefetch" href="/assets/js/29.aca5231f.js"><link rel="prefetch" href="/assets/js/3.cc8f990c.js"><link rel="prefetch" href="/assets/js/30.b0c74906.js"><link rel="prefetch" href="/assets/js/31.41b824b5.js"><link rel="prefetch" href="/assets/js/32.95d89f8c.js"><link rel="prefetch" href="/assets/js/33.7387a515.js"><link rel="prefetch" href="/assets/js/34.3fa9be34.js"><link rel="prefetch" href="/assets/js/35.905a5d0a.js"><link rel="prefetch" href="/assets/js/36.d7ce4b9a.js"><link rel="prefetch" href="/assets/js/37.fd8aaeb0.js"><link rel="prefetch" href="/assets/js/38.b36232f9.js"><link rel="prefetch" href="/assets/js/39.ae371aa8.js"><link rel="prefetch" href="/assets/js/4.b6f813b6.js"><link rel="prefetch" href="/assets/js/40.9e77645d.js"><link rel="prefetch" href="/assets/js/41.7aced1a6.js"><link rel="prefetch" href="/assets/js/42.3431685d.js"><link rel="prefetch" href="/assets/js/43.3c61b623.js"><link rel="prefetch" href="/assets/js/44.74706cc8.js"><link rel="prefetch" href="/assets/js/45.6deb7af6.js"><link rel="prefetch" href="/assets/js/46.51a84a36.js"><link rel="prefetch" href="/assets/js/47.446a6488.js"><link rel="prefetch" href="/assets/js/48.eeb843b8.js"><link rel="prefetch" href="/assets/js/49.f35e84a6.js"><link rel="prefetch" href="/assets/js/5.6c42c548.js"><link rel="prefetch" href="/assets/js/50.39dc3799.js"><link rel="prefetch" href="/assets/js/51.2e98eda6.js"><link rel="prefetch" href="/assets/js/52.0ebf3a07.js"><link rel="prefetch" href="/assets/js/53.7fbd54a4.js"><link rel="prefetch" href="/assets/js/54.42c54b92.js"><link rel="prefetch" href="/assets/js/55.1c372827.js"><link rel="prefetch" href="/assets/js/56.3db642d3.js"><link rel="prefetch" href="/assets/js/57.385f3c0e.js"><link rel="prefetch" href="/assets/js/58.fcb950f6.js"><link rel="prefetch" href="/assets/js/59.b77c39f3.js"><link rel="prefetch" href="/assets/js/6.249f79ed.js"><link rel="prefetch" href="/assets/js/60.4e20518b.js"><link rel="prefetch" href="/assets/js/61.86f57283.js"><link rel="prefetch" href="/assets/js/62.a4fe965c.js"><link rel="prefetch" href="/assets/js/63.c5dbf72b.js"><link rel="prefetch" href="/assets/js/64.f9242d96.js"><link rel="prefetch" href="/assets/js/65.63c88e9b.js"><link rel="prefetch" href="/assets/js/66.fa97a8fa.js"><link rel="prefetch" href="/assets/js/67.9de0f89d.js"><link rel="prefetch" href="/assets/js/68.3959d250.js"><link rel="prefetch" href="/assets/js/69.8d33bb82.js"><link rel="prefetch" href="/assets/js/7.965b9c14.js"><link rel="prefetch" href="/assets/js/70.eae11422.js"><link rel="prefetch" href="/assets/js/71.9dcc9639.js"><link rel="prefetch" href="/assets/js/72.d9858851.js"><link rel="prefetch" href="/assets/js/73.1f5d46fd.js"><link rel="prefetch" href="/assets/js/74.55cfc98d.js"><link rel="prefetch" href="/assets/js/75.1c8f9b5f.js"><link rel="prefetch" href="/assets/js/76.9712797a.js"><link rel="prefetch" href="/assets/js/77.fc4c4708.js"><link rel="prefetch" href="/assets/js/78.9e58022f.js"><link rel="prefetch" href="/assets/js/79.8958c264.js"><link rel="prefetch" href="/assets/js/80.25f206a9.js"><link rel="prefetch" href="/assets/js/81.82b297fd.js"><link rel="prefetch" href="/assets/js/82.95a92348.js"><link rel="prefetch" href="/assets/js/83.1d856c8a.js"><link rel="prefetch" href="/assets/js/84.2fe27c01.js"><link rel="prefetch" href="/assets/js/85.119d769d.js"><link rel="prefetch" href="/assets/js/86.dda9549d.js"><link rel="prefetch" href="/assets/js/87.5f96db0f.js"><link rel="prefetch" href="/assets/js/88.09fc8a79.js"><link rel="prefetch" href="/assets/js/89.86b4ddcb.js"><link rel="prefetch" href="/assets/js/90.85df2a8a.js"><link rel="prefetch" href="/assets/js/91.593d62b4.js"><link rel="prefetch" href="/assets/js/92.1f4f1612.js"><link rel="prefetch" href="/assets/js/93.3cf32b8f.js"><link rel="prefetch" href="/assets/js/94.ddb588cb.js"><link rel="prefetch" href="/assets/js/95.850c9613.js"><link rel="prefetch" href="/assets/js/96.5e20d25c.js"><link rel="prefetch" href="/assets/js/97.41935f73.js"><link rel="prefetch" href="/assets/js/98.9c3b2db4.js"><link rel="prefetch" href="/assets/js/99.6c498302.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4849e3bc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0fbd704.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">扎星的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS编程练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS常见设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS高阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>V8引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步I/O和异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TCP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/001/" class="sidebar-link">Vue.js 运行机制全局概览</a></li><li><a href="/vue/002/" class="sidebar-link">响应式系统的基本原理</a></li><li><a href="/vue/003/" class="sidebar-link">响应式系统的依赖收集追踪原理</a></li><li><a href="/vue/004/" class="sidebar-link">实现 Virtual DOM 下的一个 VNode 节点</a></li><li><a href="/vue/005/" aria-current="page" class="active sidebar-link">template 模板是怎样通过 Compile 编译的</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue/005/#compile" class="sidebar-link">Compile</a></li><li class="sidebar-sub-header"><a href="/vue/005/#parse" class="sidebar-link">parse</a></li><li class="sidebar-sub-header"><a href="/vue/005/#advance" class="sidebar-link">advance</a></li><li class="sidebar-sub-header"><a href="/vue/005/#optimize" class="sidebar-link">optimize</a></li><li class="sidebar-sub-header"><a href="/vue/005/#generate" class="sidebar-link">generate</a></li></ul></li><li><a href="/vue/006/" class="sidebar-link">数据状态更新时的差异 diff 及 patch 机制</a></li><li><a href="/vue/007/" class="sidebar-link">批量异步更新策略及 nextTick 原理</a></li><li><a href="/vue/008/" class="sidebar-link">008 Vuex 状态管理的工作原理</a></li><li><a href="/vue/009/" class="sidebar-link">Vue3 Diff算法</a></li><li><a href="/vue/010/" class="sidebar-link">Vue3 响应式原理</a></li><li><a href="/vue/011/" class="sidebar-link">Vue2/3 响应式对数组的处理</a></li><li><a href="/vue/012/" class="sidebar-link">012 手写 Vuex 核心原理</a></li><li><a href="/vue/013/" class="sidebar-link">013 v-model 语法糖</a></li><li><a href="/vue/014/" class="sidebar-link">014 vue 的通信机制</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="template-模板是怎样通过-compile-编译的"><a href="#template-模板是怎样通过-compile-编译的" class="header-anchor">#</a> template 模板是怎样通过 Compile 编译的</h1> <h2 id="compile"><a href="#compile" class="header-anchor">#</a> Compile</h2> <p>compile 编译可以分成 parse、optimize 与 generate 三个阶段，最终需要得到 render function。这部分内容不算 Vue.js 的响应式核心，只是用来编译的，笔者认为在精力有限的情况下不需要追究其全部的实现细节，能够把握如何解析的大致流程即可。</p> <p><img src="/assets/img/1.048577a7.jpg" alt="1"></p> <p>由于解析过程比较复杂，直接上代码可能会导致不了解这部分内容的同学一头雾水。所以笔者准备提供一个 template 的示例，通过这个示例的变化来看解析的过程。但是解析的过程及结果都是将最重要的部分抽离出来展示，希望能让读者更好地了解其核心部分的实现。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>demo<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isShow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in sz<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{item}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">'&lt;div :class=&quot;c&quot; class=&quot;demo&quot; v-if=&quot;isShow&quot;&gt;&lt;span v-for=&quot;item in sz&quot;&gt;{{item}}&lt;/span&gt;&lt;/div&gt;'</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来的过程都会依赖这个示例来进行。</p> <h2 id="parse"><a href="#parse" class="header-anchor">#</a> parse</h2> <p>首先是 parse，parse 会用正则等方式将 template 模板中进行字符串解析，得到指令、class、style等数据，形成 AST（在计算机科学中，抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码。）。</p> <p>这个过程比较复杂，会涉及到比较多的正则进行字符串解析，我们来看一下得到的 AST 的样子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token comment">/* 标签属性的map，记录了标签上属性 */</span>
    <span class="token string-property property">'attrsMap'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">':class'</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'class'</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'v-if'</span><span class="token operator">:</span> <span class="token string">'isShow'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/* 解析得到的:class */</span>
    <span class="token string-property property">'classBinding'</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span>
    <span class="token comment">/* 标签属性v-if */</span>
    <span class="token string-property property">'if'</span><span class="token operator">:</span> <span class="token string">'isShow'</span><span class="token punctuation">,</span>
    <span class="token comment">/* v-if的条件 */</span>
    <span class="token string-property property">'ifConditions'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">'exp'</span><span class="token operator">:</span> <span class="token string">'isShow'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">/* 标签属性class */</span>
    <span class="token string-property property">'staticClass'</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
    <span class="token comment">/* 标签的tag */</span>
    <span class="token string-property property">'tag'</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    <span class="token comment">/* 子标签数组 */</span>
    <span class="token string-property property">'children'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">'attrsMap'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">'v-for'</span><span class="token operator">:</span> <span class="token string">&quot;item in sz&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">/* for循环的参数 */</span>
            <span class="token string-property property">'alias'</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">/* for循环的对象 */</span>
            <span class="token string-property property">'for'</span><span class="token operator">:</span> <span class="token string">'sz'</span><span class="token punctuation">,</span>
            <span class="token comment">/* for循环是否已经被处理的标记位 */</span>
            <span class="token string-property property">'forProcessed'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string-property property">'tag'</span><span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'children'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">/* 表达式，_s是一个转字符串的函数 */</span>
                    <span class="token string-property property">'expression'</span><span class="token operator">:</span> <span class="token string">'_s(item)'</span><span class="token punctuation">,</span>
                    <span class="token string-property property">'text'</span><span class="token operator">:</span> <span class="token string">'{{item}}'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre></div><p>最终得到的 AST 通过一些特定的属性，能够比较清晰地描述出标签的属性以及依赖关系。</p> <p>接下来我们用代码来讲解一下如何使用正则来把 template 编译成我们需要的 AST 的。</p> <h3 id="正则"><a href="#正则" class="header-anchor">#</a> 正则</h3> <p>首先我们定义一下接下来我们会用到的正则。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token string">'[a-zA-Z_][\\w\\-\\.]*'</span><span class="token punctuation">;</span> <span class="token comment">// </span>
<span class="token keyword">const</span> singleAttrIdentifier <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([^\s&quot;'&lt;&gt;/=]+)</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> singleAttrAssign <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:=)</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> singleAttrValues <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&quot;([^&quot;]*)&quot;+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
  <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">'([^']*)'+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
  <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([^\s&quot;'=&lt;&gt;`]+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span>source
<span class="token punctuation">]</span>
<span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>
  <span class="token string">'^\\s*'</span> <span class="token operator">+</span> singleAttrIdentifier<span class="token punctuation">.</span>source <span class="token operator">+</span>
  <span class="token string">'(?:\\s*('</span> <span class="token operator">+</span> singleAttrAssign<span class="token punctuation">.</span>source <span class="token operator">+</span> <span class="token string">')'</span> <span class="token operator">+</span>
  <span class="token string">'\\s*(?:'</span> <span class="token operator">+</span> singleAttrValues<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'))?'</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token string">'((?:'</span> <span class="token operator">+</span> ncname <span class="token operator">+</span> <span class="token string">'\\:)?'</span> <span class="token operator">+</span> ncname <span class="token operator">+</span> <span class="token string">')'</span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'^&lt;'</span> <span class="token operator">+</span> qnameCapture<span class="token punctuation">)</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)&gt;</span><span class="token regex-delimiter">/</span></span>

<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'^&lt;\\/'</span> <span class="token operator">+</span> qnameCapture <span class="token operator">+</span> <span class="token string">'[^&gt;]*&gt;'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> defaultTagRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{((?:.|\n)+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>

<span class="token keyword">const</span> forAliasRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(.*?)\s+(?:in|of)\s+(.*)</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><h2 id="advance"><a href="#advance" class="header-anchor">#</a> advance</h2> <p>因为我们解析 template 采用循环进行字符串匹配的方式，所以每匹配解析完一段我们需要将已经匹配掉的去掉，头部的指针指向接下来需要匹配的部分。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">advance</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> n
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>举个例子，当我们把第一个 div 的头标签全部匹配完毕以后，我们需要将这部分除去，也就是向右移动 43 个字符。</p> <p><img src="data:image/jpeg;base64,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" alt="2"></p> <p>调用 advance 函数</p> <div class="language- extra-class"><pre class="language-text"><code>advance(43);
</code></pre></div><p>得到结果</p> <p><img src="data:image/jpeg;base64,UklGRrAaAABXRUJQVlA4WAoAAAAgAAAARwQAxQAASUNDUHQCAAAAAAJ0YXBwbAQAAABtbnRyUkdCIFhZWiAH3AALAAwAEgA6ABdhY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWFwcGxmSfnZPIV3n7QGSpkeOnQsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAtkZXNjAAABCAAAAGNkc2NtAAABbAAAACxjcHJ0AAABmAAAAC13dHB0AAAByAAAABRyWFlaAAAB3AAAABRnWFlaAAAB8AAAABRiWFlaAAACBAAAABRyVFJDAAACGAAAABBiVFJDAAACKAAAABBnVFJDAAACOAAAABBjaGFkAAACSAAAACxkZXNjAAAAAAAAAAlIRCA3MDktQQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbWx1YwAAAAAAAAABAAAADGVuVVMAAAAQAAAAHABIAEQAIAA3ADAAOQAtAEF0ZXh0AAAAAENvcHlyaWdodCBBcHBsZSBDb21wdXRlciwgSW5jLiwgMjAxMAAAAABYWVogAAAAAAAA81IAAQAAAAEWz1hZWiAAAAAAAABvoQAAOSMAAAOMWFlaIAAAAAAAAGKWAAC3vAAAGMpYWVogAAAAAAAAJJ4AAA87AAC2znBhcmEAAAAAAAAAAAAB9gRwYXJhAAAAAAAAAAAAAfYEcGFyYQAAAAAAAAAAAAH2BHNmMzIAAAAAAAEMQgAABd7///MmAAAHkgAA/ZH///ui///9owAAA9wAAMBsVlA4IBYYAACQiwCdASpIBMYAPpFInkwlpCKiIbiI0LASCWVu/EsZp1xv6B2uTsmMifM/v3o+VT/Yf0vzDdKnYHlK80+SL1Afmj2AP65/avN8/ZD3C/1j/Z/kB8AP5l/jv2s90H+uf8z/Ge4T+m/5T9j/9V8gH9H/0v/19qj/UewL/ev9r7Af8t/vPqv/7j9zP/R8jn9R/2f7e/+H5Ef2P//n/D/8vwAegB/0PUA9Sfr15sfIjHR1D/M5EFLHnf/sO9XgBOz/G+YF7Gfbv158iHVZlSMqSgd4rWinUW6VIadY6x1jrHWOsdY6x1jrFyC3sIrSYGT3DqkAU43eZ9gn721af36yjHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOsW9OlqXhjpPfvHHqiPbas2vKw3Ur6/gSAkBICQEgJASAkBICQEgJASAkBICQEgJASAkBH5cQi/jL1MxeHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOeImZby4waiBmLw6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOsdYt9cx+mpTcm5Nybk3JuTcm5Nybk3JuTcm5Nybk3JuTcm5Nyalu5STn8uJcS4lxLiXEuJcS4lxLiXEuJcS4lxLiXEuJcS4j+tMIgrVDo1mH5wpoJASAkBICQEgJASAkBICQEZ69QvpegdsV/Ki+Fsq15vf5tuxy/aH53Y6xayP4DUMlJtiJayT0uGhFNWwW+OQ+M6HVjhsHmTcA3bWl2HxkYCkJ06eputebExqFcdQGL3eGrOlrMcGVmkpK7sexRR0KXJHtSNXDCPp4ZcKI4HguvlJX/il+RKtBEJ2gpvNL2L+XFkGnLFGezLa2mHNp5+tWYnh9hYxoWqQeA7uHEKd784h4fdFLCu5u5tkzfE3EElHkdvFuH4/+sxu9JuZUxlTweFLopBhihmKYI9fA/yLOhhklhbasjp374dRtV5ptxIhjq2yRXeaqTdEBwCCSoMS8zG+svbb0PcGcMCXv8kp96nM6mNlcJ2Swrdfd3QZNdlkaZQbUrt3cXMFp+ZUNNdrozVe5it+QUgGAZUPzo74J7eMmBglZucJhvi7HfvqVc1yfSFVIvcwWIm2nRBmF+89lEWn7b6dW+5VVXqzi5k6AzS+PLBhMdKXZ5UGAK94rAm0A5M69RN8YHHRJxBsxMbnmRrBwoPGb7PiIxtpNhyszb4+CrWpkNtX56qmiI2FEI2BO1IvZ75PRCTZIXApsQKbS0wTSAaSRG7gCEx83b6eNfD0DVE543KMMweZI1ieKm/TgCpaagZ9Y4NcMg2EWz8EKd68oHEWz6lQgYYW78Pc+3UTEuhohNn0/jJJhigosTceNlsxsehHe6VQrM5duNvk/mzdm7N2bs3Zuzdm7N2bs3Z56zX5cS4lxLiXRKa4m6wRqIGYvDrHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHWOsdY6x1jrHNAA/v+WYChOxB1/qdbM1KWM7ldWyDOI1BRFPVXfVowzQj0/2nJ/l47COfEH1ckhDwnwzjKRykg1ViAnHp6pi1x3eMr4EEqd9NHr5MNRXZcEfzLXRpDmRYXg71w7b5QsxF5IG7A4+RHdDzQxwslJ7oFMrkczFwG03Wd4FPjLXluo6jwgS/X18VJa5VWvrDoH44ssT1Qo3DyieIMr20cpUwkDKgO3RO4BFaRbMYdiIBCfMt3jihI581nm4+fNeSTMHf6yVmTFxEzeLNvzmmHLc4blsFTQ7cRpC3LH9TB8uOlnMQa+9mmqPrLwUvSoRr3yF/viXHy+1GAAAJIM9ic59afx3FbG3KsmLYDc8TXlFA30mlf9pvXHFJv2vYcmiGgkDnaZuJetSij3MKL5OjW6kc1TEI0BFK+ffmM/KFv3BAikGfFC+vI9R+DuhXgVf9TkykKhV7whqt8NhX3kAZerhXGfQUHdnXa5eK3kmlk+fTa/85XzWid+Xn6rCPRRtwKu/9jbv98446OoCqzgIT50sAGYKuQ8rwB1r1BU2qforMku8YCpdbrOBf7LbHMoF0u5Xcs+SGs7CXfI+ki7xooAAAEvw7qZDY2TPsJueHGKqL7RPOOiWJudPOAAAACuc+vZkShO0TrqvfylHYbt33c32EQN4XGL8x8jn/QAAdmQX2zD2OazMJJJGhwNjJc/uBRHEio7Y0gXNfuAAAjE7dCQOFqKyfyeQmfwHu9Ri87bVvHe0rpx9ODvOu74ORPrWc7iQAFgdlvScQKc1xyAwcGDniwi/AEG36KbWtE3x3w1UkbnhWLwYVTWJQSkaWqEOCPl6xJbFT1iUwT88Te/X+IT4Gi1AqlOsgHgxZFLBHoABQt87Bge5L4JFQhEvr1LkMUPdJ60oOYjipmtI43pf4VWRFreP268GpuiSbyrRcQrTSnjBHyvX0SS6izemKr0n8WRoe+LPtsiC4nqxKWrQO2ib6kCjvrHZwaXIfmQiQxQU4nXVBxsxMHaYF/zjEEZWL10IuVghDkLI4tFfi21+qunpo9iXLVhfYl4zA+/PQSQUKu0vaAI4AA0zcCv6N+pfoZ1bYbr1Cg3oz2y+5ePXNx8NRZHdAHGKqmLXg6tHiqgtBlTDtfPBcO+WpI0AVa+wHmdjkI2BnXe/7EpRT6eSKBVeU8iX/aCYgQoUnrxv3aNf+b7ig3xp1sR5dz95/m172OIBNBSKOgDzn4OgRiBH+D1MRiKepewxq/Pdu0Mmxq8pKq5dMdrar14jrbQF6XsMJBtka65r1jukBYBKnPttJb5QLG3PAMPZN6D2Axfp3FN0MZ8BciJ7u9bk0FusJ2HeNsGffL3eY0Hr/y8JhpEI4Po5pmjHabIzzyAzmn54IoLU9X4S2oRxenR1vZ4HMpdnaQ3aq00Ns2z/WaBm8AfDJwTkakseHA/+E1GAySBxkpghU83uJruo71+jNwA/+uQVb9UtQqc45CUIJ2hf+1GGFo/0+12BKXQAheeI66KTBJWgXaQJyIbtpJorGfjMdre20VhQ4BncBjWwVflLhhKAcEYQ7dkCXEO4XdJM2/7DsedAH8N2tCZCnG+ODxTE7+lptNHdzNfDEnllo3jGRtm3yW6RXXa68hmdW6yWL/cUXOQ4KN1Jx4Kzb0anH05wgIs4zAstb2WPzIxmEUOGpvExMZP2+3S9pmkHiiVfM9BZC1Ao4LCKUe4BhqzWoO9ZV3CTCt1iztK5qF85DOWuNAX6kqXovlzR5B6xb0rHH1QZR+Qo8sx6AvBCZ4u5nMHMfmQm1q9vYiTUeR7D1g4+LA3tErH8lkTFv4EJS858iRSbpDcoOxmgNaN22T0BpSca7BGLYKVYH+obV7GYbmSWyQEL9PTRdaEVS+FkLETTx9IdavS8ogCe/hJZq9AYbwfNX42vorsDBA3u819t+OFh0i63yVrQoGqDBvdEP5uYJf/NJSXlqs2Q9aZlNXHMWiKfGj/uN/6pOuRbyaP0UEpmOG+mBHj6Zc/7TvOCVzmQ3VcnzveOIWjjO8kGCe6HZfDlbnfO8n3C5OjliGcXBSkBqq8qKACycImd+Yz8707NcZCcJK3qvpso3NfAU6ajoWzQsiGhg7PE3BvhyQpOJUdXuuFGy9tDD8+ffySfONquJ0odYrpVrA/pEUyHmWOQfY17ue+bONP0kPipjPQ7MJXD1nSjLra1bldyLw5JzYz+Dwxyicch7Oqp6kC9w2jki6y2oUlUgwziORiLtSRw/xZ0+doKT9KKEtGrQfGOoRUYdcDdDmVdaQXGdDMIimc3EnsDdLw/7vCwG2v/E6B/NzzudGyZcrxie3p53L4gbeMp3apavGz29szWNAnq4QsODeNj9hafXC6ORWSCL8paGKoX7qXHvblVHWs7rnZFVhFJwn9g1d3OlD+W18bTrn43OtV/+SJ6Loe1jwOmWD9rzHnjBevczd/qJTUDitDN2W7JB9ch/NO07JmT+5RXBACBEDAH7b1O3uFxrremDX1Z5fTW3Z6U7SCPLF0NZJ2SrfPyZKP7wXOwUBV95L2fuT8S3FGDxot3Ux2tQuK5P1woUI+1iEtpIqES8KXUS7SumJW76RPCoAiwLm8ehmoTjHAgxoy9gq3IrJH+JdAZS54Wr7DT1TGf1SKZ8U37PHz+FdYCC2rll6wFRj26uWIHWlYMRRU9TcOT/B6/rRbsgyO8xy9xzB8uEsVKjjB8XgKQULQjlH80Qd0e1UvDkf4mKjFQg9IZ4/9wz7Kz3zEgU7q/Uv/MVzYSNkmh4NLeHOyhXUqFcJZWrxxSXBqKEnVHzNizhCaDv42vem4rbkFwWUogvJkOKruK9DZ1HZKnkpCgElN/Ez2kB1k7ivu2jtbiYAcFXWj41BvdHWpDz+iFj4PwNdyECPyOIDkKjmTbDXKBx3xx/wG9Dc6GgN1cjZ7MWfRhl7b7EL6ozThqOvOYAoYRJ8SNeWKIyG9hIQDdNgsNLbENGu1xGCg4gd7XjeK1JW5J1Np1iHERoNoupJUz8F5l0P10TDgojYzyYygQYjrfewj3dbPzkmQIFGdGBJYKRzAVikNQZ/Kj4e5H5OmRs/HgWht92PDKKsbM2W4PueF31BkwjnUOM5XApG+nBwbVdYcQ3PG1c76zCAhi/nAEbsx5EO2h1jX2NsNZF9nIYw4f9a0qK5LXLQ4SfCoF/Ra0KwZiXdU7+PKpC67HzAkUfNrM2+8WFZn965mA11Hfb4enlMIX8U1uOhOhWPli48WYsFSxbiSHbzZIrAdi2XbNKdAdobGkmRRhP1miPWqo30wnkcWd9GGPi7e6wFOWuayY9+xPx+kERr4Pb/4CLsl7rHtz+UeaZ+nB7+w/xlBotH/VSttVAyg3vspJkkt03RvM+jJ4zE3JFqNNwXhaUUCu8jW2hM4ugOnCF3kPbHQ5htiwRtNTj7pA/6COQ+W2ljZiyT5ZNIOifKpTkZbDreTK1I32HzS8LFPSXqwUo45A5upWKy8I02QPGd682FjcYn6spqmxZzttXyVlqQbd1U4TZmGYqThR0F1/fMU+h5VfMJRUp9jTFJM6/AgG9aFT6jVAvX7zv0V6wnzWbsn8hfCOJkUbS6LYli5s21fezIOhmmMRlqUUw26qdx1s/Bznd8X2RNyf9unnVQv7GM9x4Ay/cfF1WgSiIti8/ytcyKK490/FVQ/fjGVxJA4P7ZiflvM4gZs471HkwQ7AKvLZzD/Emll8ViMeiw7NEI6z1oU/pXtpO9Cp/vB5Hrjxv1lRXd1KDP8lGK4YpbuqPIoPYy+TKbLJSFZpGFWd0b4KO4TjJIhnNMWewz7hryN11hvGkg2HsinTTS9WH1fgWO4o+43I4kbPFhSsqdcgPzV1Q1Bzku/TBBaffCManiz/lSPfZbxjyL4xMMN86pCeHjiTV9lHbStiet/gt8Np8kjPNwr8T+q/aTpWHfeBRNdjQuq487p1ch3a29mGi5LkEu98C9ciVSOQeIamXclm7tEInzeB4ya7rSF3L+Lx3f/Pzcdt3Hvri2X14nbkieWkBMh11RpomcVkyqrfDNw+1oFk3KduOGCMUleWtoQmc4N61bKUToExujPcotyKjwq+0HWr1UBgIXYCjXqvX0VBa7lTW/nib9bdP/60b7ZmUJmdYqP2P1ukpK2gXxo3w5Ti4R881fYc7epa3RfZikSs2nXD7/smQ/d5eMGNAsr9rx52xiS46oddpcRc9fshbuJFmkRAKyAp5XuRoRokSk8Q0//iffrQzqMT6xyLqn6jGsUvZFlbgKNRdUPx7sroHEKue1AtZ1xXQzlVmwv4l49LolJLCPm8QLNvjk6URg6q3gt2qUIDvvsoPEoule9by2hzLjtsJHp59UA1HIjTnlvpC+Zy9L1Q5QNqIB+9gQaTGSr95XRgmKx7cpTNxlRvNaqCQHGVc1D1iEYvrNeUQJng+zV2E08nB8Kzb2LWRGnV4/YC3p5rfOzwmcP22HlLyOz8NXtZzmA7GIBhhIyd9LhloNjQLjrfguRNEuZkHOqrFfr0tq2URp6X09YR47XmqSxpYT3GgyToOOHZHK5ECPoGS9Cr8XGZJ8Mmo6OrorGv+6O2n3XGN+g6y4OFYnvqnScwfayIGgZs1zawKjAI19Pp3OJq0ck5njpxylVOE1lWLsHBZ4yNbPxrlMAO/3w8smYPcNnyc5gXOBlhmjEEyvROY196Bnxolua2eacXZMuDDKCyVDAUuX0giopf0HLsAEYhCJ978SiZYJp4RhWaczhSkPa1dokOeyZEdRaNTXBIq1g8McHgMV9QFH2XtRj9g9nYWjI4maGoxlODzqvnY5E45SBotJoNQvkAIdtdrTLQKGVr4HP2Wp3hn/HNE96Lgw2OsUzKvYKI1ITozB70Ew7LvLCgECTb9qtP8qMV1UfGmvBedDcX9mpKnvNmmPDdWcbNDN/THxNvX7a2rZqXVKCMutfxiH24yslyILW0Jps+mYDNJVSPfuYlE6/I4vqLcCzBCj/pqPqQGGWgfZb7p8zssktnS2HPdMqdt8EIRP3PO9EEKx76dWUlJZqyRhohYhSNMkG6jOc7/yCHX1lMdOj2d0tfNYv1xj2BRX07ge77+4upYvxKtwbxDZnQpx+UD9quxAuPXTvUS9JIu/ezQaB2ltt/idIBs3G/RJKWajKeVIBItIXhT6i+uJSMirejoMx4IS53Urj57GaBthh0T6yjsKoVYKTV9yG2TKC3K1zoh4O3k8SHnai51CMkLyenDc2h2vIi6gfWMfaADVWhYH60IEK+E+EUzM8rmcEmXv9C53Xa0ywNPZ7np6NRlesNtIPk3bq/0YmNgsw995zculE/IR/aHiBubj+wtrP/tIdiaAYek3XAAGYj1PxnfkoEMoG/wS33fZlPRYYwaWaS+fsXc8Uzl9Oaai/uL6QI1/rBkx6QI+EJs7UW1Efbfp67iOuL+ay14aOXWI0vE47EtW+dVZZSkaVOdYIAQ5mNuerUb7NPtFUZ/ESJQrjYTZE9aE+E/ekylMsQ4lJfPt+euwJJVlhfYTxHCvf9wEtvRsYLDI1UkiD5Y238Af/zi8Mv8TxgXt/1dY0Qxo8Eke16tKDePGroRVSaI6UKbl54o9R4xPJQRePvyM8LUWxZmzvdO1dhUGjatpq9ryL1JKdQaWmNkxRVVJ8GV7K336zmYJzzJaMplfMVV2bPQCaBJZA/t0O6w0NFwJfnoXPxuvaJRDQvY7+1uMRI8t7frbIN/wg7mrFLBm1aFtIdgQx+g8eiXygsmtf+FRLIbTZ+zo/SoMrMC1FxOJhxzwd5MuVSddVD9YhyI++7M/9KbiwK+2oNptNrOM9dccJ4P9hucnGNfm98WrBbVb/7tzMjNVb9y8QQ7UuDlbGASMEZ6VZwK8Gb2mAoTO7A9vfpSniv2i83FSlqWBY6Nw+G9mulchpyR+gMv4+crcHf9LeAnxs/86UCcr1QAt8TaI1ZQIQQS2e1jQops4o0pLs4a5Ig6gwzBO0NqBciz/efHq4XEQVtYxW2GdSHn6pEGqKrjiuVNA/cAJx2fPcwuFAGrzaUbfNXOcQHI11X9+h5km5To/r6TK5befayjeUeWykol+gyXo1UqyAhxt+2Zc9vE3zflItHvcvVumOhbX07kCtoxHiPQOSMFVPBLf0CBXPDczwqcrN3Fi/DCs5gNxC/TezVCdbwPn6gR0FN0VxOG0po4EzEuDueiIlW2PQUap04JpXr3youSCH+9i/bMnIyvApzwt5j8NbGRVwnNMix+22hcsPxmg26SddbtlhW2Pg7foCh7fdQSapw4lLvYUVd7DYLaZjQwLpxJCAVA4IG38hEe+Gsd2qBg1qU/UrCql19DzEtPHQHWfeHrgMYFqk7ichkyr+3InGT5et6gvXmCNxkTtJv2Obc2NgHMN/hoPyRp529/wTf8NBDgDcVdAC4XgL08wVqI9IahgBFrq2q5yl9pqyxIRE/TMIExDyw/3pRsAkQDAvr3H+UxrknA7XmLYejCm4A011h8qYeg3QJ+GX3wcnwkGpCA7uj7O180KrbM46Tmt2dEkBlffnh+XeK282ReuZHakC95TVS10mIl8iirNiVLGOUXDJs7OtHZiYYFat0ooBMx5yFUWqYsuyKWMI4/okBbZJAorjGO9Ya/LnHe4wUg3gCGu7pEE0wrjHJ5/lvCWTXmr2J60Ul/mcNBbVdgxh///vDVv+NQmE8hlD4FtWQAAAAAAAAAAAAAAA" alt="3"></p> <h3 id="parsehtml"><a href="#parsehtml" class="header-anchor">#</a> parseHTML</h3> <p>首先我们需要定义个 parseHTML 函数，在里面我们循环解析 template 字符串。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseHTML</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//...process end tag</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//...process start tag</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//...process text</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>parseHTML 会用 while 来循环解析 template ，用正则在匹配到标签头、标签尾以及文本的时候分别进行不同的处理。直到整个 template 被解析完毕。</p> <h3 id="parsestarttag"><a href="#parsestarttag" class="header-anchor">#</a> parseStartTag</h3> <p>我们来写一个 parseStartTag 函数，用来解析起始标签<code>&quot;&lt;div :class=&quot;c&quot; class=&quot;demo&quot; v-if=&quot;isShow&quot;&gt;&quot;</code>部分的内容</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseStartTag</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">tagName</span><span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">start</span><span class="token operator">:</span> index
        <span class="token punctuation">}</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> end<span class="token punctuation">,</span> attr
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">name</span><span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token literal-property property">value</span><span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            match<span class="token punctuation">.</span>end <span class="token operator">=</span> index<span class="token punctuation">;</span>
            <span class="token keyword">return</span> match
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来使用 startTagClose 与 attribute 两个正则分别用来解析标签结束以及标签内的属性。这段代码用 while 循环一直到匹配到 startTagClose 为止，解析内部所有的属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> end<span class="token punctuation">,</span> attr
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> attr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    match<span class="token punctuation">.</span>end <span class="token operator">=</span> index<span class="token punctuation">;</span>
    <span class="token keyword">return</span> match
<span class="token punctuation">}</span>
</code></pre></div><h3 id="stack"><a href="#stack" class="header-anchor">#</a> stack</h3> <p>此外，我们需要维护一个 stack 栈来保存已经解析好的标签头，这样我们可以根据在解析尾部标签的时候得到所属的层级关系以及父标签。同时我们定义一个 currentParent 变量用来存放当前标签的父标签节点的引用， root 变量用来指向根标签节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> currentParent<span class="token punctuation">,</span> root<span class="token punctuation">;</span>
</code></pre></div><p><img src="data:image/jpeg;base64,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" alt="4"></p> <p>知道这个以后，我们优化一下 parseHTML ，在 startTagOpen 的 if 逻辑中加上新的处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// type = 1 指的是标签元素</span>
        <span class="token literal-property property">tag</span><span class="token operator">:</span> startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
        <span class="token literal-property property">lowerCasedTag</span><span class="token operator">:</span> startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">attrsList</span><span class="token operator">:</span> startTagMatch<span class="token punctuation">.</span>attrs<span class="token punctuation">,</span>
        <span class="token literal-property property">attrsMap</span><span class="token operator">:</span> <span class="token function">makeAttrsMap</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">parent</span><span class="token operator">:</span> currentParent<span class="token punctuation">,</span>
        <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span><span class="token punctuation">{</span>
        root <span class="token operator">=</span> element
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>currentParent<span class="token punctuation">)</span><span class="token punctuation">{</span>
        currentParent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentParent <span class="token operator">=</span> element<span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们将 startTagMatch 得到的结果首先封装成 element ，这个就是最终形成的 AST 的节点，标签节点的 type 为 1。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span>
    <span class="token literal-property property">attrsList</span><span class="token operator">:</span> startTagMatch<span class="token punctuation">.</span>attrs<span class="token punctuation">,</span>
    <span class="token literal-property property">attrsMap</span><span class="token operator">:</span> <span class="token function">makeAttrsMap</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">parent</span><span class="token operator">:</span> currentParent<span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后让 root 指向根节点的引用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span><span class="token punctuation">{</span>
    root <span class="token operator">=</span> element
<span class="token punctuation">}</span>
</code></pre></div><p>接着我们将当前节点的 element 放入父节点 currentParent 的 children 数组中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span>currentParent<span class="token punctuation">)</span><span class="token punctuation">{</span>
    currentParent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后将当前节点 element 压入 stack 栈中，并将 currentParent 指向当前节点，因为接下去下一个解析如果还是头标签或者是文本的话，会成为当前节点的子节点，如果是尾标签的话，那么将会从栈中取出当前节点，这种情况我们接下来要讲。</p> <div class="language-js extra-class"><pre class="language-js"><code>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
currentParent <span class="token operator">=</span> element<span class="token punctuation">;</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
</code></pre></div><p>其中的 makeAttrsMap 是将 attrs 转换成 map 格式的一个方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeAttrsMap</span> <span class="token punctuation">(</span><span class="token parameter">attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">[</span>attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> map
<span class="token punctuation">}</span>
</code></pre></div><h3 id="parseendtag"><a href="#parseendtag" class="header-anchor">#</a> parseEndTag</h3> <p>parseEndTag 匹配闭合标签，并将之前已经入栈的起始标签出栈，说明这一块元素已经解析完毕。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  parseEndTag 来解析尾标签，它会从 stack 栈中取出最近的跟自己标签名一致的那个元素，将 currentParent 指向那个元素，并将该元素之前的元素都从 stack 中出栈。</span>
<span class="token keyword">function</span> <span class="token function">parseEndTag</span> <span class="token punctuation">(</span><span class="token parameter">tagName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pos<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> pos<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>lowerCasedTag <span class="token operator">===</span> tagName<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stack<span class="token punctuation">.</span>length <span class="token operator">=</span> pos<span class="token punctuation">;</span>
    currentParent <span class="token operator">=</span> stack<span class="token punctuation">[</span>pos<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="parsetext"><a href="#parsetext" class="header-anchor">#</a> parseText</h3> <p>举例：字符串 <code>&lt;div&gt;hello,.&lt;/div&gt;</code>
通过解析最终得到的 tokens<code>tokens = ['hello,', _s(name), '.'];</code>
最终通过 join 返回表达式。<code>'hello' + _s(name) + '.';</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseText</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 如果 text 不包含 {{}} 则为普通文本，直接返回即可</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>defaultTagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> defaultTagRE<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> match<span class="token punctuation">,</span> index

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> defaultTagRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">=</span> match<span class="token punctuation">.</span>index

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> exp <span class="token operator">=</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_s(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastIndex <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> tokens<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="processif与processfor"><a href="#processif与processfor" class="header-anchor">#</a> processIf与processFor</h3> <p>最后介绍一下如何处理“v-if”以及“v-for”这样的 Vue.js 的表达式的，这里我们只简单介绍两个示例中用到的表达式解析。</p> <p>我们只需要在解析头标签的内容中加入这两个表达式的解析函数即可，在这时“v-for”之类指令已经在属性解析时存入了 attrsMap 中了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">processFor</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> exp<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exp <span class="token operator">=</span> <span class="token function">getAndRemoveAtrr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-for'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析 v-for 的内容  例如 v-for=&quot;(item) in sz&quot;</span>
    <span class="token keyword">const</span> inMatch <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>forAliasRE<span class="token punctuation">)</span>
    el<span class="token punctuation">.</span>for <span class="token operator">=</span> inMatch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// for 的对象</span>
    el<span class="token punctuation">.</span>alias <span class="token operator">=</span> inMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 循环的参数，别称</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">processIf</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> exp <span class="token operator">=</span> <span class="token function">getAndRemoveAtrr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-if'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>if <span class="token operator">=</span> exp<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>ifConditions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">exp</span><span class="token operator">:</span> exp<span class="token punctuation">,</span> <span class="token comment">// 条件表达式</span>
      <span class="token literal-property property">block</span><span class="token operator">:</span> el
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="optimize"><a href="#optimize" class="header-anchor">#</a> optimize</h2> <p>optimize 主要作用就跟它的名字一样，用作「优化」。</p> <p>这个涉及到后面要讲 patch 的过程，因为 patch 的过程实际上是将 VNode 节点进行一层一层的比对，然后将「差异」更新到视图上。那么一些静态节点是不会根据数据变化而产生变化的，这些节点我们没有比对的需求，是不是可以跳过这些静态节点的比对，从而节省一些性能呢？</p> <p>那么我们就需要为静态的节点做上一些「标记」，在 patch 的时候我们就可以直接跳过这些被标记的节点的比对，从而达到「优化」的目的。</p> <p>经过 optimize 这层的处理，每个节点会加上 static 属性，用来标记是否是静态的。</p> <p>得到如下结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string-property property">'attrsMap'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">':class'</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'class'</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'v-if'</span><span class="token operator">:</span> <span class="token string">'isShow'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">'classBinding'</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'if'</span><span class="token operator">:</span> <span class="token string">'isShow'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'ifConditions'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string-property property">'exp'</span><span class="token operator">:</span> <span class="token string">'isShow'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">'staticClass'</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'tag'</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
    <span class="token comment">/* 静态标志 */</span>
    <span class="token string-property property">'static'</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string-property property">'children'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string-property property">'attrsMap'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string-property property">'v-for'</span><span class="token operator">:</span> <span class="token string">&quot;item in sz&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">'static'</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string-property property">'alias'</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">'for'</span><span class="token operator">:</span> <span class="token string">'sz'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'forProcessed'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string-property property">'tag'</span><span class="token operator">:</span> <span class="token string">'span'</span><span class="token punctuation">,</span>
            <span class="token string-property property">'children'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string-property property">'expression'</span><span class="token operator">:</span> <span class="token string">'_s(item)'</span><span class="token punctuation">,</span>
                    <span class="token string-property property">'text'</span><span class="token operator">:</span> <span class="token string">'{{item}}'</span><span class="token punctuation">,</span>
                    <span class="token string-property property">'static'</span><span class="token operator">:</span> <span class="token boolean">false</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们用代码实现一下 optimize 函数。</p> <h3 id="isstatic"><a href="#isstatic" class="header-anchor">#</a> isStatic</h3> <p>首先实现一个 isStatic 函数，传入一个 node 判断该 node 是否是静态节点。判断的标准是当 type 为 2（表达式节点）则是非静态节点，当 type 为 3（文本节点）的时候则是静态节点，当然，如果存在 if 或者 for这样的条件的时候（表达式节点），也是非静态节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isStatic</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="markstatic"><a href="#markstatic" class="header-anchor">#</a> markStatic</h3> <p>markStatic 为所有的节点标记上 static，遍历所有节点通过 isStatic 来判断当前节点是否是静态节点，此外，会遍历当前节点的所有子节点，如果子节点是非静态节点，那么当前节点也是非静态节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStatic</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="markstaticroots"><a href="#markstaticroots" class="header-anchor">#</a> markStaticRoots</h3> <p>接下来是 markStaticRoots 函数，用来标记 staticRoot（静态根）。这个函数实现比较简单，简单来讲就是如果当前节点是静态节点，且它只有一个文本子节点，且该节点为文本节点，则不需要标记静态节点，作者认为这种情况下优化的消耗会大于收益。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStaticRoots</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>
        node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
        node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="generate"><a href="#generate" class="header-anchor">#</a> generate</h2> <p>generate 会将 AST 转化成 render funtion 字符串，最终得到 render 的字符串以及 staticRenderFns 字符串。</p> <p>首先带大家感受一下真实的 Vue.js 编译得到的结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>isShow<span class="token punctuation">)</span> <span class="token operator">?</span> 
    <span class="token function">_c</span><span class="token punctuation">(</span>
        <span class="token string">'div'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">staticClass</span><span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span>
            <span class="token keyword">class</span><span class="token operator">:</span> c
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">_l</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">_e</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看到这里可能会纳闷了，这些 _c，_l 到底是什么？其实他们是 Vue.js 对一些函数的简写，比如说 _c 对应的是 createElement 这个函数。没关系，我们把它用 VNode 的形式写出来就会明白了，这个对接上一章写的 VNode 函数。</p> <p>首先是第一层 div 节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> isShow <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'staticClass'</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'class'</span><span class="token operator">:</span> c
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token comment">/*这里还有子节点*/</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们在 children 中加上第二层 span 及其子文本节点节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* 渲染v-for列表 */</span>
<span class="token keyword">function</span> <span class="token function">renderList</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> render</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> val<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> isShow <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'staticClass'</span><span class="token operator">:</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'class'</span><span class="token operator">:</span> c
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
        <span class="token comment">/* begin */</span>
        <span class="token function">renderList</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
                <span class="token function">createTextVNode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">/* end */</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那我们如何来实现一个 generate 呢？</p> <h3 id="genif"><a href="#genif" class="header-anchor">#</a> genIf</h3> <p>首先实现一个处理 if 条件的 genIf 函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genIf</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>ifProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'_e()'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: _e()</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="genfor"><a href="#genfor" class="header-anchor">#</a> genFor</h3> <p>然后是处理 for 循环的函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genFor</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>forProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> exp <span class="token operator">=</span> el<span class="token punctuation">.</span>for<span class="token punctuation">;</span>
    <span class="token keyword">const</span> alias <span class="token operator">=</span> el<span class="token punctuation">.</span>alias<span class="token punctuation">;</span>
    <span class="token keyword">const</span> iterator1 <span class="token operator">=</span> el<span class="token punctuation">.</span>iterator1 <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>iterator1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> iterator2 <span class="token operator">=</span> el<span class="token punctuation">.</span>iterator2 <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>iterator2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_l((</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">),</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>alias<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iterator1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iterator2<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">){</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token string">'})'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="gentext"><a href="#gentext" class="header-anchor">#</a> genText</h3> <p>处理文本节点的函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genText</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_v(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="genelement"><a href="#genelement" class="header-anchor">#</a> genElement</h3> <p>接下来实现一下 genElement，这是一个处理节点的函数，因为它依赖 genChildren 以及g enNode ，所以这三个函数放在一起讲。</p> <p>genElement会根据当前节点是否有 if 或者 for 标记然后判断是否要用 genIf 或者 genFor 处理，否则通过 genChildren 处理子节点，同时得到 staticClass、class 等属性。</p> <p>genChildren 比较简单，遍历所有子节点，通过 genNode 处理后用“，”隔开拼接成字符串。</p> <p>genNode 则是根据 type 来判断该节点是用文本节点 genText 还是标签节点 genElement 来处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genNode</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">genText</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">genChildren</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>children<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>children <span class="token operator">&amp;&amp;</span> children<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>genNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">genElement</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>ifProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>forProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> code<span class="token punctuation">;</span>
        code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,'{
            staticClass: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>attrsMap <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">':class'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,
            class: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>attrsMap <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,
        }</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
            children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>
        <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">return</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="generate-2"><a href="#generate-2" class="header-anchor">#</a> generate</h3> <p>最后我们使用上面的函数来实现 generate，其实很简单，我们只需要将整个 AST 传入后判断是否为空，为空则返回一个 div 标签，否则通过 generate 来处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">generate</span> <span class="token punctuation">(</span><span class="token parameter">rootAst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> rootAst <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>rootAst<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'_c(&quot;div&quot;)'</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">render</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>经历过这些过程以后，我们已经把 template 顺利转成了 render function 了，最后通过 new Function (code) 即可生成函数。接下来我们将介绍 patch 的过程，来看一下具体 VNode 节点如何进行差异的比对。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue/004/" class="prev">
        实现 Virtual DOM 下的一个 VNode 节点
      </a></span> <span class="next"><a href="/vue/006/">
        数据状态更新时的差异 diff 及 patch 机制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7faaeb90.js" defer></script><script src="/assets/js/2.4ceac094.js" defer></script><script src="/assets/js/1.06e97743.js" defer></script><script src="/assets/js/23.4cc8500e.js" defer></script>
  </body>
</html>
