<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异常处理 | 扎星的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.8c09bca5.css" as="style"><link rel="preload" href="/assets/js/app.68bcc21e.js" as="script"><link rel="preload" href="/assets/js/2.df3e4849.js" as="script"><link rel="preload" href="/assets/js/68.2248a782.js" as="script"><link rel="prefetch" href="/assets/js/10.4fa21d0c.js"><link rel="prefetch" href="/assets/js/100.a7c67571.js"><link rel="prefetch" href="/assets/js/101.1ce6d8ee.js"><link rel="prefetch" href="/assets/js/102.4fef5e7e.js"><link rel="prefetch" href="/assets/js/103.158a9ff8.js"><link rel="prefetch" href="/assets/js/104.abb10eb9.js"><link rel="prefetch" href="/assets/js/105.5fdc4925.js"><link rel="prefetch" href="/assets/js/106.b42f4dbc.js"><link rel="prefetch" href="/assets/js/107.7c64c79b.js"><link rel="prefetch" href="/assets/js/108.065bda7a.js"><link rel="prefetch" href="/assets/js/109.6ff6c8b4.js"><link rel="prefetch" href="/assets/js/11.8c76a1bf.js"><link rel="prefetch" href="/assets/js/110.5031e466.js"><link rel="prefetch" href="/assets/js/111.c62a65c6.js"><link rel="prefetch" href="/assets/js/112.fe19b95a.js"><link rel="prefetch" href="/assets/js/113.8c1b858c.js"><link rel="prefetch" href="/assets/js/114.f7082016.js"><link rel="prefetch" href="/assets/js/115.05c28e87.js"><link rel="prefetch" href="/assets/js/116.aae9e290.js"><link rel="prefetch" href="/assets/js/117.80ee2176.js"><link rel="prefetch" href="/assets/js/118.478b97d1.js"><link rel="prefetch" href="/assets/js/119.7e651dde.js"><link rel="prefetch" href="/assets/js/12.0fe079dd.js"><link rel="prefetch" href="/assets/js/120.8917b0a2.js"><link rel="prefetch" href="/assets/js/121.f81b04eb.js"><link rel="prefetch" href="/assets/js/122.3b92d0e6.js"><link rel="prefetch" href="/assets/js/123.901faf89.js"><link rel="prefetch" href="/assets/js/13.aa6c0f0b.js"><link rel="prefetch" href="/assets/js/14.6cd57988.js"><link rel="prefetch" href="/assets/js/15.cbd6c92e.js"><link rel="prefetch" href="/assets/js/16.ce5b7f5e.js"><link rel="prefetch" href="/assets/js/17.77028844.js"><link rel="prefetch" href="/assets/js/18.900f2272.js"><link rel="prefetch" href="/assets/js/19.6bdd95eb.js"><link rel="prefetch" href="/assets/js/20.1d092af7.js"><link rel="prefetch" href="/assets/js/21.8b6e0eae.js"><link rel="prefetch" href="/assets/js/22.4f313d8a.js"><link rel="prefetch" href="/assets/js/23.c1a9a180.js"><link rel="prefetch" href="/assets/js/24.47c045fe.js"><link rel="prefetch" href="/assets/js/25.fb2c18c6.js"><link rel="prefetch" href="/assets/js/26.58af4147.js"><link rel="prefetch" href="/assets/js/27.49ad2c7b.js"><link rel="prefetch" href="/assets/js/28.6586a2a9.js"><link rel="prefetch" href="/assets/js/29.38405dba.js"><link rel="prefetch" href="/assets/js/3.718626c9.js"><link rel="prefetch" href="/assets/js/30.7f0d22d8.js"><link rel="prefetch" href="/assets/js/31.63280a59.js"><link rel="prefetch" href="/assets/js/32.c3a00710.js"><link rel="prefetch" href="/assets/js/33.5cd6d28a.js"><link rel="prefetch" href="/assets/js/34.5fb6be8b.js"><link rel="prefetch" href="/assets/js/35.31c6b0e4.js"><link rel="prefetch" href="/assets/js/36.44832f43.js"><link rel="prefetch" href="/assets/js/37.0d0e163f.js"><link rel="prefetch" href="/assets/js/38.eb0daf3f.js"><link rel="prefetch" href="/assets/js/39.dc48dc9c.js"><link rel="prefetch" href="/assets/js/4.dc0b9889.js"><link rel="prefetch" href="/assets/js/40.274b3aaf.js"><link rel="prefetch" href="/assets/js/41.f23c843f.js"><link rel="prefetch" href="/assets/js/42.9d7c4e81.js"><link rel="prefetch" href="/assets/js/43.62fde47e.js"><link rel="prefetch" href="/assets/js/44.f219cc85.js"><link rel="prefetch" href="/assets/js/45.ff5f4257.js"><link rel="prefetch" href="/assets/js/46.cd087c62.js"><link rel="prefetch" href="/assets/js/47.976408d6.js"><link rel="prefetch" href="/assets/js/48.32d1676e.js"><link rel="prefetch" href="/assets/js/49.f10f00cc.js"><link rel="prefetch" href="/assets/js/5.a372d006.js"><link rel="prefetch" href="/assets/js/50.6e2ae914.js"><link rel="prefetch" href="/assets/js/51.e608ad23.js"><link rel="prefetch" href="/assets/js/52.0d85cc42.js"><link rel="prefetch" href="/assets/js/53.e84a148a.js"><link rel="prefetch" href="/assets/js/54.7b3a2cf5.js"><link rel="prefetch" href="/assets/js/55.8dab2075.js"><link rel="prefetch" href="/assets/js/56.ba6abf70.js"><link rel="prefetch" href="/assets/js/57.ac0ae7af.js"><link rel="prefetch" href="/assets/js/58.ad2bc8e9.js"><link rel="prefetch" href="/assets/js/59.407b1d32.js"><link rel="prefetch" href="/assets/js/6.b9f5be84.js"><link rel="prefetch" href="/assets/js/60.eb0640b0.js"><link rel="prefetch" href="/assets/js/61.208195c0.js"><link rel="prefetch" href="/assets/js/62.78df72ec.js"><link rel="prefetch" href="/assets/js/63.34fb985b.js"><link rel="prefetch" href="/assets/js/64.6493e093.js"><link rel="prefetch" href="/assets/js/65.4a3dcc42.js"><link rel="prefetch" href="/assets/js/66.5de6b57e.js"><link rel="prefetch" href="/assets/js/67.24bade72.js"><link rel="prefetch" href="/assets/js/69.24e6542e.js"><link rel="prefetch" href="/assets/js/7.12962e86.js"><link rel="prefetch" href="/assets/js/70.cf80b6cd.js"><link rel="prefetch" href="/assets/js/71.08631771.js"><link rel="prefetch" href="/assets/js/72.460992a6.js"><link rel="prefetch" href="/assets/js/73.4d0c13f1.js"><link rel="prefetch" href="/assets/js/74.c1a08907.js"><link rel="prefetch" href="/assets/js/75.644a7a6d.js"><link rel="prefetch" href="/assets/js/76.286d685f.js"><link rel="prefetch" href="/assets/js/77.201dda5d.js"><link rel="prefetch" href="/assets/js/78.7ad2fea8.js"><link rel="prefetch" href="/assets/js/79.51b5b503.js"><link rel="prefetch" href="/assets/js/8.791cc050.js"><link rel="prefetch" href="/assets/js/80.3013288f.js"><link rel="prefetch" href="/assets/js/81.c1429b0d.js"><link rel="prefetch" href="/assets/js/82.2418f558.js"><link rel="prefetch" href="/assets/js/83.83768632.js"><link rel="prefetch" href="/assets/js/84.b7a28c02.js"><link rel="prefetch" href="/assets/js/85.e36b7c1a.js"><link rel="prefetch" href="/assets/js/86.a0409766.js"><link rel="prefetch" href="/assets/js/87.74c389b7.js"><link rel="prefetch" href="/assets/js/88.42297d4a.js"><link rel="prefetch" href="/assets/js/89.e652a303.js"><link rel="prefetch" href="/assets/js/9.142b36f8.js"><link rel="prefetch" href="/assets/js/90.3083df1b.js"><link rel="prefetch" href="/assets/js/91.940264f1.js"><link rel="prefetch" href="/assets/js/92.84f64336.js"><link rel="prefetch" href="/assets/js/93.80519c0b.js"><link rel="prefetch" href="/assets/js/94.ef254a74.js"><link rel="prefetch" href="/assets/js/95.45aeaf31.js"><link rel="prefetch" href="/assets/js/96.c3814197.js"><link rel="prefetch" href="/assets/js/97.4b92b66f.js"><link rel="prefetch" href="/assets/js/98.a907ea9d.js"><link rel="prefetch" href="/assets/js/99.f2c0dde8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c09bca5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">扎星的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS编程练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS常见设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS高阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js-senior/001/" aria-current="page" class="active sidebar-link">异常处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js-senior/001/#回调异常处理" class="sidebar-link">回调异常处理</a></li><li class="sidebar-sub-header"><a href="/js-senior/001/#promise-异常处理" class="sidebar-link">Promise 异常处理</a></li><li class="sidebar-sub-header"><a href="/js-senior/001/#action-概念中的异常处理" class="sidebar-link">action 概念中的异常处理</a></li><li class="sidebar-sub-header"><a href="/js-senior/001/#装饰器" class="sidebar-link">装饰器</a></li><li class="sidebar-sub-header"><a href="/js-senior/001/#全局错误" class="sidebar-link">全局错误</a></li></ul></li><li><a href="/js-senior/002/" class="sidebar-link">插件机制（中间件）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>V8引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步I/O和异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TCP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h1> <h2 id="回调异常处理"><a href="#回调异常处理" class="header-anchor">#</a> 回调异常处理</h2> <h3 id="场景一-直接抛出错误"><a href="#场景一-直接抛出错误" class="header-anchor">#</a> 场景一：直接抛出错误</h3> <p>结果：异步回调中，回调函数的执行栈与原函数分离开，导致外部无法抓住异常。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'请求失败'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求处理'</span><span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'触发异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
<span class="token punctuation">}</span>

<span class="token comment">// 计时器到期后程序崩溃</span>
<span class="token comment">// Uncaught Error: 请求失败</span>
</code></pre></div><h3 id="场景二-传递错误处理函数交由给业务方"><a href="#场景二-传递错误处理函数交由给业务方" class="header-anchor">#</a> 场景二：传递错误处理函数交由给业务方</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">handleError<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token string">'请求失败'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'失败处理'</span><span class="token punctuation">)</span> <span class="token comment">// 失败处理</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求处理'</span><span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>虽然使用了 error-first 约定，使异常看起来变得可处理，但业务方依然没有对异常的控制权，是否调用错误处理取决于回调函数是否执行，我们无法知道调用的函数是否可靠。</p> <p>更糟糕的问题是，业务方必须处理异常，否则程序挂掉就会什么都不做，这对大部分不用特殊处理异常的场景造成了很大的精神负担。</p> <h2 id="promise-异常处理"><a href="#promise-异常处理" class="header-anchor">#</a> Promise 异常处理</h2> <h3 id="场景一-catch"><a href="#场景一-catch" class="header-anchor">#</a> 场景一：catch</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'用户不存在'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求成功处理'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求处理异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 请求处理异常 用户不存在</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>不仅是 reject，抛出的异常也会被作为拒绝状态被 Promise 捕获，这里的 throw Error 最后也会被 catch() 方法捕捉到。</p> <p>但是如果在 Promise 中的异步抛出错误：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'用户不存在'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求成功处理'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求处理异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 请求处理异常 用户不存在</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 程序崩溃</span>
<span class="token comment">// Uncaught Error: 用户不存在</span>
</code></pre></div><p>永远不要在 macrotask 队列中抛出异常，因为 macrotask 队列脱离了运行上下文环境，异常无法被当前作用域捕获。</p> <p>微任务中抛出的错误（throw Error()）可以被捕获，宏任务中抛出的任务无法被捕获，所以要在宏任务中使用 reject() 方法。</p> <h3 id="场景二-第三方函数抛出错误"><a href="#场景二-第三方函数抛出错误" class="header-anchor">#</a> 场景二：第三方函数抛出错误</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'三方函数异常'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 捕获异常</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>请注意，如果 return thirdFunction() 这行缺少了 return 的话，依然无法抓住这个错误，这是因为没有将对方返回的 Promise 传递下去，错误也不会继续传递。
我们发现，这样还不是完美的办法，不但容易忘记 return，而且当同时含有多个第三方函数时，处理方式不太优雅：</p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">thirdFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'捕获异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="async-和-await"><a href="#async-和-await" class="header-anchor">#</a> Async 和 Await</h3> <p>在 Async 函数中，我们使用 try catch 捕获异常。</p> <p>因为此时的异步其实在一个作用域中，通过 generator 控制执行顺序，所以可以将异步看做同步的代码去编写，包括使用 try catch 捕获异常。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'no'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求处理'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 异常 no</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>如果有多个函数需要执行的话就可以写成：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求处理'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异常'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="action-概念中的异常处理"><a href="#action-概念中的异常处理" class="header-anchor">#</a> action 概念中的异常处理</h2> <p>为了防止程序崩溃，需要业务线在所有 async 函数中包裹 try catch</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'successReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// successReuqest 处理返回值 a</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">allReuqest</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'allReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值 success'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span> <span class="token comment">// allReuqest 处理返回值 success a</span>
      <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'allReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值 success'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'有错误了'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
action<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 无法捕获异常，抛出错误</span>
action<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 无法捕获异常，抛出错误</span>
action<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 成功捕获异常</span>
</code></pre></div><h2 id="装饰器"><a href="#装饰器" class="header-anchor">#</a> 装饰器</h2> <h3 id="类级装饰器"><a href="#类级装饰器" class="header-anchor">#</a> 类级装饰器：</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncClass</span> <span class="token operator">=</span> <span class="token punctuation">(</span>errorHandler<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">?</span><span class="token operator">:</span> Error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把传入 target 对象的每一个自有属性都进行封装，并用 try...catch 进行包裹，在出错的情况下利用 errorHandler 进行处理</span>
  Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> func <span class="token operator">=</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      target<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">await</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              errorHandler <span class="token operator">&amp;&amp;</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 处理之后返回 target 对象</span>
  <span class="token keyword">return</span> target
<span class="token punctuation">}</span>


<span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>

<span class="token comment">// 生成的装饰器方法</span>
<span class="token keyword">const</span> iAsyncClass <span class="token operator">=</span> <span class="token function">asyncClass</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'统一异常处理'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 错误处理方法</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

@iAsyncClass
<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'successReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'allReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值 success'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span>
        <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'allReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值 success'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
action<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 成功捕获异常</span>
action<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 成功捕获异常</span>
action<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 成功捕获异常</span>
</code></pre></div><h3 id="方法-函数-级装饰器"><a href="#方法-函数-级装饰器" class="header-anchor">#</a> 方法（函数）级装饰器：</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncMethod</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">errorHandler<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">?</span><span class="token operator">:</span> Error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> any<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> string<span class="token punctuation">,</span> descriptor<span class="token operator">:</span> PropertyDescriptor</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取具体的方法</span>
  <span class="token keyword">const</span> func <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>value
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 重写方法并返回</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                  errorHandler <span class="token operator">&amp;&amp;</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token operator">:</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> newValue
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">successRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">failRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> asyncAction <span class="token operator">=</span> <span class="token function">asyncMethod</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'统一异常处理'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token comment">// 统一异常处理 b</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Action</span> <span class="token punctuation">{</span>
    @asyncAction <span class="token keyword">async</span> <span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'successReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    @asyncAction <span class="token keyword">async</span> <span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span>

    @asyncAction <span class="token keyword">async</span> <span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">successRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'allReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值 success'</span><span class="token punctuation">,</span> result1<span class="token punctuation">)</span>
        <span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">failRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'allReuqest'</span><span class="token punctuation">,</span> <span class="token string">'处理返回值 success'</span><span class="token punctuation">,</span> result2<span class="token punctuation">)</span> <span class="token comment">// 永远不会执行</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
action<span class="token punctuation">.</span><span class="token function">successReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
action<span class="token punctuation">.</span><span class="token function">failReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
action<span class="token punctuation">.</span><span class="token function">allReuqest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="业务方拥有处理错误的主动权"><a href="#业务方拥有处理错误的主动权" class="header-anchor">#</a> 业务方拥有处理错误的主动权</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">nickname<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>nickname<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token comment">// 跳转到首页，登录失败后不会执行到这，所以不用担心用户看到奇怪的跳转</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>no <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 跳转到登录页</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// 其他错误不想管，把球继续踢走</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="全局错误"><a href="#全局错误" class="header-anchor">#</a> 全局错误</h2> <h3 id="nodejs"><a href="#nodejs" class="header-anchor">#</a> nodejs</h3> <p>在 nodejs 端，记得监听全局错误，兜住落网之鱼：</p> <p>process.on('uncaughtException', (error: any) =&gt; {
logger.error('uncaughtException', error)
})</p> <p>process.on('unhandledRejection', (error: any) =&gt; {
logger.error('unhandledRejection', error)
})</p> <h3 id="浏览器端"><a href="#浏览器端" class="header-anchor">#</a> 浏览器端</h3> <p>在浏览器端，记得监听 window 全局错误，兜住漏网之鱼：</p> <p>window.addEventListener('unhandledrejection', (event: any) =&gt; {
logger.error('unhandledrejection', event)
})
window.addEventListener('onrejectionhandled', (event: any) =&gt; {
logger.error('onrejectionhandled', event)
})</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/design-pattern/004/" class="prev">
        代理模式
      </a></span> <span class="next"><a href="/js-senior/002/">
        插件机制（中间件）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.68bcc21e.js" defer></script><script src="/assets/js/2.df3e4849.js" defer></script><script src="/assets/js/68.2248a782.js" defer></script>
  </body>
</html>
