<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器运行机制 | 扎星的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.b0fbd704.css" as="style"><link rel="preload" href="/assets/js/app.7faaeb90.js" as="script"><link rel="preload" href="/assets/js/2.4ceac094.js" as="script"><link rel="preload" href="/assets/js/1.06e97743.js" as="script"><link rel="preload" href="/assets/js/30.b0c74906.js" as="script"><link rel="prefetch" href="/assets/js/10.4d67db37.js"><link rel="prefetch" href="/assets/js/100.9ada27ad.js"><link rel="prefetch" href="/assets/js/101.7eccfd40.js"><link rel="prefetch" href="/assets/js/102.e344b695.js"><link rel="prefetch" href="/assets/js/103.b91c2e2b.js"><link rel="prefetch" href="/assets/js/104.6f90f799.js"><link rel="prefetch" href="/assets/js/105.73780a6e.js"><link rel="prefetch" href="/assets/js/106.e8737813.js"><link rel="prefetch" href="/assets/js/107.5f785c2c.js"><link rel="prefetch" href="/assets/js/108.74958d5b.js"><link rel="prefetch" href="/assets/js/109.d3005515.js"><link rel="prefetch" href="/assets/js/11.32340e89.js"><link rel="prefetch" href="/assets/js/110.65860f7f.js"><link rel="prefetch" href="/assets/js/111.d91c32b6.js"><link rel="prefetch" href="/assets/js/112.a5e8efc2.js"><link rel="prefetch" href="/assets/js/113.191ff9e1.js"><link rel="prefetch" href="/assets/js/114.eb21d1d8.js"><link rel="prefetch" href="/assets/js/115.ed058567.js"><link rel="prefetch" href="/assets/js/116.c73d4a79.js"><link rel="prefetch" href="/assets/js/117.c1195019.js"><link rel="prefetch" href="/assets/js/118.b2aeca16.js"><link rel="prefetch" href="/assets/js/119.666dc6c6.js"><link rel="prefetch" href="/assets/js/12.f3209147.js"><link rel="prefetch" href="/assets/js/120.548bb39a.js"><link rel="prefetch" href="/assets/js/121.d6368bb6.js"><link rel="prefetch" href="/assets/js/122.14d59fae.js"><link rel="prefetch" href="/assets/js/123.7e5e4cc0.js"><link rel="prefetch" href="/assets/js/124.a9c9fc37.js"><link rel="prefetch" href="/assets/js/125.2de4a8c4.js"><link rel="prefetch" href="/assets/js/126.6d029a58.js"><link rel="prefetch" href="/assets/js/127.3f37c3d9.js"><link rel="prefetch" href="/assets/js/128.3bab5bc7.js"><link rel="prefetch" href="/assets/js/129.fde4fcbb.js"><link rel="prefetch" href="/assets/js/13.ff905545.js"><link rel="prefetch" href="/assets/js/130.21002715.js"><link rel="prefetch" href="/assets/js/131.e261ff32.js"><link rel="prefetch" href="/assets/js/132.f4df11c1.js"><link rel="prefetch" href="/assets/js/133.3082ed5c.js"><link rel="prefetch" href="/assets/js/134.f583893d.js"><link rel="prefetch" href="/assets/js/135.4930a3bf.js"><link rel="prefetch" href="/assets/js/136.088fe073.js"><link rel="prefetch" href="/assets/js/137.3b78020c.js"><link rel="prefetch" href="/assets/js/138.19b200da.js"><link rel="prefetch" href="/assets/js/139.890d6075.js"><link rel="prefetch" href="/assets/js/14.c3568dfc.js"><link rel="prefetch" href="/assets/js/140.5b795da9.js"><link rel="prefetch" href="/assets/js/141.15c2c5e7.js"><link rel="prefetch" href="/assets/js/142.c336f1c2.js"><link rel="prefetch" href="/assets/js/143.0eba62e9.js"><link rel="prefetch" href="/assets/js/144.556773e6.js"><link rel="prefetch" href="/assets/js/15.7af482c3.js"><link rel="prefetch" href="/assets/js/16.1add91f2.js"><link rel="prefetch" href="/assets/js/17.5211db13.js"><link rel="prefetch" href="/assets/js/18.cb58294e.js"><link rel="prefetch" href="/assets/js/19.3f4c86e4.js"><link rel="prefetch" href="/assets/js/20.f6e9413a.js"><link rel="prefetch" href="/assets/js/21.d3127fc5.js"><link rel="prefetch" href="/assets/js/22.75a3675d.js"><link rel="prefetch" href="/assets/js/23.4cc8500e.js"><link rel="prefetch" href="/assets/js/24.6e9f6fde.js"><link rel="prefetch" href="/assets/js/25.59ab9b92.js"><link rel="prefetch" href="/assets/js/26.b6ea8fe3.js"><link rel="prefetch" href="/assets/js/27.eb622419.js"><link rel="prefetch" href="/assets/js/28.82216df1.js"><link rel="prefetch" href="/assets/js/29.aca5231f.js"><link rel="prefetch" href="/assets/js/3.cc8f990c.js"><link rel="prefetch" href="/assets/js/31.41b824b5.js"><link rel="prefetch" href="/assets/js/32.95d89f8c.js"><link rel="prefetch" href="/assets/js/33.7387a515.js"><link rel="prefetch" href="/assets/js/34.3fa9be34.js"><link rel="prefetch" href="/assets/js/35.905a5d0a.js"><link rel="prefetch" href="/assets/js/36.d7ce4b9a.js"><link rel="prefetch" href="/assets/js/37.fd8aaeb0.js"><link rel="prefetch" href="/assets/js/38.b36232f9.js"><link rel="prefetch" href="/assets/js/39.ae371aa8.js"><link rel="prefetch" href="/assets/js/4.b6f813b6.js"><link rel="prefetch" href="/assets/js/40.9e77645d.js"><link rel="prefetch" href="/assets/js/41.7aced1a6.js"><link rel="prefetch" href="/assets/js/42.3431685d.js"><link rel="prefetch" href="/assets/js/43.3c61b623.js"><link rel="prefetch" href="/assets/js/44.74706cc8.js"><link rel="prefetch" href="/assets/js/45.6deb7af6.js"><link rel="prefetch" href="/assets/js/46.51a84a36.js"><link rel="prefetch" href="/assets/js/47.446a6488.js"><link rel="prefetch" href="/assets/js/48.eeb843b8.js"><link rel="prefetch" href="/assets/js/49.f35e84a6.js"><link rel="prefetch" href="/assets/js/5.6c42c548.js"><link rel="prefetch" href="/assets/js/50.39dc3799.js"><link rel="prefetch" href="/assets/js/51.2e98eda6.js"><link rel="prefetch" href="/assets/js/52.0ebf3a07.js"><link rel="prefetch" href="/assets/js/53.7fbd54a4.js"><link rel="prefetch" href="/assets/js/54.42c54b92.js"><link rel="prefetch" href="/assets/js/55.1c372827.js"><link rel="prefetch" href="/assets/js/56.3db642d3.js"><link rel="prefetch" href="/assets/js/57.385f3c0e.js"><link rel="prefetch" href="/assets/js/58.fcb950f6.js"><link rel="prefetch" href="/assets/js/59.b77c39f3.js"><link rel="prefetch" href="/assets/js/6.249f79ed.js"><link rel="prefetch" href="/assets/js/60.4e20518b.js"><link rel="prefetch" href="/assets/js/61.86f57283.js"><link rel="prefetch" href="/assets/js/62.a4fe965c.js"><link rel="prefetch" href="/assets/js/63.c5dbf72b.js"><link rel="prefetch" href="/assets/js/64.f9242d96.js"><link rel="prefetch" href="/assets/js/65.63c88e9b.js"><link rel="prefetch" href="/assets/js/66.fa97a8fa.js"><link rel="prefetch" href="/assets/js/67.9de0f89d.js"><link rel="prefetch" href="/assets/js/68.3959d250.js"><link rel="prefetch" href="/assets/js/69.8d33bb82.js"><link rel="prefetch" href="/assets/js/7.965b9c14.js"><link rel="prefetch" href="/assets/js/70.eae11422.js"><link rel="prefetch" href="/assets/js/71.9dcc9639.js"><link rel="prefetch" href="/assets/js/72.d9858851.js"><link rel="prefetch" href="/assets/js/73.1f5d46fd.js"><link rel="prefetch" href="/assets/js/74.55cfc98d.js"><link rel="prefetch" href="/assets/js/75.1c8f9b5f.js"><link rel="prefetch" href="/assets/js/76.9712797a.js"><link rel="prefetch" href="/assets/js/77.fc4c4708.js"><link rel="prefetch" href="/assets/js/78.9e58022f.js"><link rel="prefetch" href="/assets/js/79.8958c264.js"><link rel="prefetch" href="/assets/js/80.25f206a9.js"><link rel="prefetch" href="/assets/js/81.82b297fd.js"><link rel="prefetch" href="/assets/js/82.95a92348.js"><link rel="prefetch" href="/assets/js/83.1d856c8a.js"><link rel="prefetch" href="/assets/js/84.2fe27c01.js"><link rel="prefetch" href="/assets/js/85.119d769d.js"><link rel="prefetch" href="/assets/js/86.dda9549d.js"><link rel="prefetch" href="/assets/js/87.5f96db0f.js"><link rel="prefetch" href="/assets/js/88.09fc8a79.js"><link rel="prefetch" href="/assets/js/89.86b4ddcb.js"><link rel="prefetch" href="/assets/js/90.85df2a8a.js"><link rel="prefetch" href="/assets/js/91.593d62b4.js"><link rel="prefetch" href="/assets/js/92.1f4f1612.js"><link rel="prefetch" href="/assets/js/93.3cf32b8f.js"><link rel="prefetch" href="/assets/js/94.ddb588cb.js"><link rel="prefetch" href="/assets/js/95.850c9613.js"><link rel="prefetch" href="/assets/js/96.5e20d25c.js"><link rel="prefetch" href="/assets/js/97.41935f73.js"><link rel="prefetch" href="/assets/js/98.9c3b2db4.js"><link rel="prefetch" href="/assets/js/99.6c498302.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4849e3bc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0fbd704.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">扎星的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS编程练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS常见设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS高阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>性能优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/performance/guide/" class="sidebar-link">001前端性能优化知识体系导读</a></li><li><a href="/performance/webpack/" class="sidebar-link">002webpack性能调优与gzip原理</a></li><li><a href="/performance/picture/" class="sidebar-link">003图片优化</a></li><li><a href="/performance/cache/" class="sidebar-link">004浏览器缓存机制和策略</a></li><li><a href="/performance/storage/" class="sidebar-link">005浏览器本地存储</a></li><li><a href="/performance/rendering/" class="sidebar-link">006服务端渲染的探索与实践</a></li><li><a href="/performance/operating/" aria-current="page" class="active sidebar-link">007浏览器运行机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/performance/operating/#浏览器的内核" class="sidebar-link">浏览器的内核</a></li><li class="sidebar-sub-header"><a href="/performance/operating/#渲染过程" class="sidebar-link">渲染过程</a></li><li class="sidebar-sub-header"><a href="/performance/operating/#浏览器渲染过程解析" class="sidebar-link">浏览器渲染过程解析</a></li><li class="sidebar-sub-header"><a href="/performance/operating/#几棵重要的-树" class="sidebar-link">几棵重要的“树”</a></li><li class="sidebar-sub-header"><a href="/performance/operating/#基于渲染流程的-css-优化建议" class="sidebar-link">基于渲染流程的 CSS 优化建议</a></li><li class="sidebar-sub-header"><a href="/performance/operating/#css-与-js-的加载顺序优化" class="sidebar-link">CSS 与 JS 的加载顺序优化</a></li><li class="sidebar-sub-header"><a href="/performance/operating/#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/performance/DOM/" class="sidebar-link">008DOM优化原理与基本实践</a></li><li><a href="/performance/eventloop/" class="sidebar-link">009Event Loop 与异步更新策略</a></li><li><a href="/performance/reflow&amp;repaint/" class="sidebar-link">010回流和重绘</a></li><li><a href="/performance/debounce&amp;throttle/" class="sidebar-link">011防抖和节流</a></li><li><a href="/performance/performanceAPI/" class="sidebar-link">012性能检测篇: PerformanceAPI</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>V8引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步I/O和异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TCP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器运行机制"><a href="#浏览器运行机制" class="header-anchor">#</a> 浏览器运行机制</h1> <h2 id="浏览器的内核"><a href="#浏览器的内核" class="header-anchor">#</a> 浏览器的内核</h2> <p>浏览器内核可以分成两部分：渲染引擎（Layout Engine 或者 Rendering Engine）和 JS 引擎。早期渲染引擎和 JS 引擎并没有十分明确的区分，但随着 JS 引擎越来越独立，内核也成了渲染引擎的代称（下文我们将沿用这种叫法）。渲染引擎又包括了 HTML 解释器、CSS 解释器、布局、网络、存储、图形、音视频、图片解码器等等零部件。</p> <p>目前市面上常见的浏览器内核可以分为这四种：Trident（IE）、Gecko（火狐）、Blink（Chrome、Opera）、Webkit（Safari）。</p> <p>这里面大家最耳熟能详的可能就是 Webkit 内核了。很多同学可能会听说过 Chrome 的内核就是 Webkit，殊不知 Chrome 内核早已迭代为了 Blink。但是换汤不换药，Blink 其实也是基于 Webkit 衍生而来的一个分支，因此，Webkit 内核仍然是当下浏览器世界真正的霸主。</p> <p>下面我们就以 Webkit 为例，对现代浏览器的渲染过程进行一个深度的剖析。</p> <h2 id="渲染过程"><a href="#渲染过程" class="header-anchor">#</a> 渲染过程</h2> <p>什么是渲染过程？简单来说，渲染引擎根据 HTML 文件描述构建相应的数学模型，调用浏览器各个零部件，从而将网页资源代码转换为图像结果，这个过程就是渲染过程（如下图）</p> <p><img src="data:image/jpeg;base64,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" alt="1"></p> <p>从这个流程来看，浏览器呈现网页这个过程，宛如一个黑盒。在这个神秘的黑盒中，有许多功能模块，内核内部的实现正是这些功能模块相互配合协同工作进行的。其中我们最需要关注的，就是HTML 解释器、CSS 解释器、图层布局计算模块、视图绘制模块与JavaScript 引擎这几大模块：</p> <ul><li>HTML 解释器：将 HTML 文档经过词法分析输出 DOM 树。</li> <li>CSS 解释器：解析 CSS 文档, 生成样式规则。</li> <li>图层布局计算模块：布局计算每个对象的精确位置和大小。</li> <li>视图绘制模块：进行具体节点的图像绘制，将像素渲染到屏幕上。</li> <li>JavaScript 引擎：编译执行 Javascript 代码。</li></ul> <h2 id="浏览器渲染过程解析"><a href="#浏览器渲染过程解析" class="header-anchor">#</a> 浏览器渲染过程解析</h2> <p>有了对零部件的了解打底，我们就可以一起来走一遍浏览器的渲染流程了。在浏览器里，每一个页面的首次渲染都经历了如下阶段（图中箭头不代表串行，有一些操作是并行进行的，下文会说明）：</p> <p><img src="/assets/img/2.ba082505.jpg" alt="2"></p> <ul><li>解析 HTML</li></ul> <p>在这一步浏览器执行了所有的加载解析逻辑，在解析 HTML 的过程中发出了页面渲染所需的各种外部资源请求。</p> <ul><li>计算样式</li></ul> <p>浏览器将识别并加载所有的 CSS 样式信息与 DOM 树合并，最终生成页面 render 树（:after :before 这样的伪元素会在这个环节被构建到 DOM 树中）。</p> <ul><li>计算图层布局</li></ul> <p>页面中所有元素的相对位置信息，大小等信息均在这一步得到计算。</p> <ul><li>绘制图层</li></ul> <p>在这一步中浏览器会根据我们的 DOM 代码结果，把每一个页面图层转换为像素，并对所有的媒体文件进行解码。</p> <ul><li>整合图层，得到页面</li></ul> <p>最后一步浏览器会合并合各个图层，将数据由 CPU 输出给 GPU 最终绘制在屏幕上。（复杂的视图层会给这个阶段的 GPU 计算带来一些压力，在实际应用中为了优化动画性能，我们有时会手动区分不同的图层）。</p> <h2 id="几棵重要的-树"><a href="#几棵重要的-树" class="header-anchor">#</a> 几棵重要的“树”</h2> <p>上面的内容没有理解透彻？别着急，我们一起来捋一捋这个过程中的重点——树！</p> <p>为了使渲染过程更明晰一些，我们需要给这些”树“们一个特写:</p> <p><img src="/assets/img/3.4b1297b2.jpg" alt="3"></p> <ul><li><p>DOM 树： 解析 HTML 以创建的 DOM 树（DOM tree）：渲染引擎开始解析 HTML 文档，转换树种的标签到 DOM 节点，它被称为“内容树”。</p></li> <li><p>CSSOM 树：解析 CSS（包括外部 CSS 文件和样式元素）创建的是 CSSOM 树。CSSOM 的解析过程与 DOM 的解析过程是并行的。</p></li> <li><p>渲染树：CSSOM 与 DOM 结合，之后我们得到的就是渲染树（Render tree ）。</p></li> <li><p>布局渲染树：从根节点递归调用，计算每一个元素的大小、位置等，给每个节点所应该出现在屏幕上的精确坐标，我们便得到了基于渲染树的布局渲染树（Layout of the render tree）。</p></li> <li><p>绘制渲染树: 遍历渲染树，每个节点将使用 UI 后端层来绘制。整个过程叫做绘制渲染树（Painting the render tree）。</p></li></ul> <h2 id="基于渲染流程的-css-优化建议"><a href="#基于渲染流程的-css-优化建议" class="header-anchor">#</a> 基于渲染流程的 CSS 优化建议</h2> <p>在给出 CSS 选择器方面的优化建议之前，先告诉大家一个小知识：CSS 引擎查找样式表，对每条规则都按从右到左的顺序去匹配。 看如下规则：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">#myList  li</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>这样的写法其实很常见。大家平时习惯了从左到右阅读的文字阅读方式，会本能地以为浏览器也是从左到右匹配 CSS 选择器的，因此会推测这个选择器并不会费多少力气：#myList 是一个 id 选择器，它对应的元素只有一个，查找起来应该很快。定位到了 myList 元素，等于是缩小了范围后再去查找它后代中的 li 元素，没毛病。</p> <p>事实上，CSS 选择符是从右到左进行匹配的。我们这个看似“没毛病”的选择器，实际开销相当高：浏览器必须遍历页面上每个 li 元素，并且每次都要去确认这个 li 元素的父元素 id 是不是 myList，你说坑不坑！</p> <p>说到坑，不知道大家还记不记得这个经典的通配符：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">*</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>入门 CSS 的时候，不少同学拿通配符清除默认样式（我曾经也是通配符用户的一员）。但这个家伙很恐怖，它会匹配所有元素，所以浏览器必须去遍历每一个元素！大家低头看看自己页面里的元素个数，是不是心凉了——这得计算多少次呀！</p> <p>这样一看，一个小小的 CSS 选择器，也有不少的门道！好的 CSS 选择器书写习惯，可以为我们带来非常可观的性能提升。根据上面的分析，我们至少可以总结出如下性能提升的方案：</p> <ul><li>避免使用通配符，只对需要用到的元素进行选择。</li> <li>关注可以通过继承实现的属性，避免重复匹配重复定义。</li> <li>少用标签选择器。如果可以，用类选择器替代，举例：</li></ul> <p>错误示范：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">#myList li</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>课代表：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.myList_li</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><ul><li>不要画蛇添足，id 和 class 选择器不应该被多余的标签选择器拖后腿。举例：
错误示范：</li></ul> <div class="language-css extra-class"><pre class="language-css"><code>.myList#title
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code>#title
</code></pre></div><ul><li>减少嵌套。后代选择器的开销是最高的，因此我们应该尽量将选择器的深度降到最低（最高不要超过三层），尽可能使用类来关联每一个标签元素。</li></ul> <h2 id="css-与-js-的加载顺序优化"><a href="#css-与-js-的加载顺序优化" class="header-anchor">#</a> CSS 与 JS 的加载顺序优化</h2> <p>HTML、CSS 和 JS，都具有阻塞渲染的特性。</p> <p>HTML 阻塞，天经地义——没有 HTML，何来 DOM？没有 DOM，渲染和优化，都是空谈。</p> <p>那么 CSS 和 JS 的阻塞又是怎么回事呢？</p> <h3 id="css-的阻塞"><a href="#css-的阻塞" class="header-anchor">#</a> CSS 的阻塞</h3> <p>在刚刚的过程中，我们提到 DOM 和 CSSOM 合力才能构建渲染树。这一点会给性能造成严重影响：默认情况下，CSS 是阻塞的资源。浏览器在构建 CSSOM 的过程中，不会渲染任何已处理的内容。即便 DOM 已经解析完毕了，只要 CSSOM 不 OK，那么渲染这个事情就不 OK（这主要是为了避免没有 CSS 的 HTML 页面丑陋地“裸奔”在用户眼前）。</p> <p>我们知道，只有当我们开始解析 HTML 后、解析到 link 标签或者 style 标签时，CSS 才登场，CSSOM 的构建才开始。很多时候，DOM 不得不等待 CSSOM。因此我们可以这样总结：</p> <blockquote><p>CSS 是阻塞渲染的资源。需要将它尽早、尽快地下载到客户端，以便缩短首次渲染的时间。</p></blockquote> <p>事实上，现在很多团队都已经做到了尽早（将 CSS 放在 head 标签里）和尽快（启用 CDN 实现静态资源加载速度的优化）。这个“把 CSS 往前放”的动作，对很多同学来说已经内化为一种编码习惯。那么现在我们还应该知道，这个“习惯”不是空穴来风，它是由 CSS 的特性决定的。</p> <h3 id="js-的阻塞"><a href="#js-的阻塞" class="header-anchor">#</a> JS 的阻塞</h3> <p>不知道大家注意到没有，前面我们说过程的时候，花了很多笔墨去说 HTML、说 CSS。相比之下，JS 的出镜率也太低了点。
这当然不是因为 JS 不重要。而是因为，在首次渲染过程中，JS 并不是一个非登场不可的角色——没有 JS，CSSOM 和 DOM 照样可以组成渲染树，页面依然会呈现——即使它死气沉沉、毫无交互。</p> <p>JS 的作用在于修改，它帮助我们修改网页的方方面面：内容、样式以及它如何响应用户交互。这“方方面面”的修改，本质上都是对 DOM 和 CSSDOM 进行修改。因此 JS 的执行会阻止 CSSOM，在我们不作显式声明的情况下，它也会阻塞 DOM。</p> <p>JS 引擎是独立于渲染引擎存在的。我们的 JS 代码在文档的何处插入，就在何处执行。当 HTML 解析器遇到一个 script 标签时，它会暂停渲染过程，将控制权交给 JS 引擎。JS 引擎对内联的 JS 代码会直接执行，对外部 JS 文件还要先获取到脚本、再进行执行。等 JS 引擎运行完毕，浏览器又会把控制权还给渲染引擎，继续 CSSOM 和 DOM 的构建。 因此与其说是 JS 把 CSS 和 HTML 阻塞了，不如说是 JS 引擎抢走了渲染引擎的控制权。</p> <p>现在理解了阻塞的表现与原理，我们开始思考一个问题。浏览器之所以让 JS 阻塞其它的活动，是因为它不知道 JS 会做什么改变，担心如果不阻止后续的操作，会造成混乱。但是我们是写 JS 的人，我们知道 JS 会做什么改变。假如我们可以确认一个 JS 文件的执行时机并不一定非要是此时此刻，我们就可以通过对它使用 defer 和 async 来避免不必要的阻塞，这里我们就引出了外部 JS 的三种加载方式。</p> <h3 id="js-的三中加载方式"><a href="#js-的三中加载方式" class="header-anchor">#</a> JS 的三中加载方式</h3> <ul><li>正常模式</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这种情况下 JS 会阻塞浏览器，浏览器必须等待 index.js 加载和执行完毕才能去做其它事情。</p> <ul><li>async 模式</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>async 模式下，JS 不会阻塞浏览器做任何其它的事情。它的加载是异步的，当它加载结束，JS 脚本会立即执行。</p> <ul><li>defer 模式</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>defer 模式下，JS 的加载是异步的，执行是被推迟的。等整个文档解析完成、DOMContentLoaded 事件即将被触发时，被标记了 defer 的 JS 文件才会开始依次执行。</p> <p>从应用的角度来说，一般当我们的脚本与 DOM 元素和其它脚本之间的依赖关系不强时，我们会选用 async；当脚本依赖于 DOM 元素和其它脚本的执行结果时，我们会选用 defer。</p> <p>通过审时度势地向 script 标签添加 async/defer，我们就可以告诉浏览器在等待脚本可用期间不阻止其它的工作，这样可以显著提升性能。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>我们知道，当 JS 登场时，往往意味着对 DOM 的操作。DOM 操作所导致的性能开销的“昂贵”，大家可能早就有所耳闻，雅虎军规里很重要的一条就是“尽量减少 DOM 访问”。</p> <p>那么 DOM 到底为什么慢，我们如何去规避这种慢呢？这里我们就引出了下一个章节需要重点解释的两个概念：CSS 中的回流（Reflow）与重绘（Repaint）。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/performance/rendering/" class="prev">
        006服务端渲染的探索与实践
      </a></span> <span class="next"><a href="/performance/DOM/">
        008DOM优化原理与基本实践
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7faaeb90.js" defer></script><script src="/assets/js/2.4ceac094.js" defer></script><script src="/assets/js/1.06e97743.js" defer></script><script src="/assets/js/30.b0c74906.js" defer></script>
  </body>
</html>
