<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>回流和重绘 | 扎星的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.b0fbd704.css" as="style"><link rel="preload" href="/assets/js/app.7faaeb90.js" as="script"><link rel="preload" href="/assets/js/2.4ceac094.js" as="script"><link rel="preload" href="/assets/js/1.06e97743.js" as="script"><link rel="preload" href="/assets/js/55.1c372827.js" as="script"><link rel="prefetch" href="/assets/js/10.4d67db37.js"><link rel="prefetch" href="/assets/js/100.9ada27ad.js"><link rel="prefetch" href="/assets/js/101.7eccfd40.js"><link rel="prefetch" href="/assets/js/102.e344b695.js"><link rel="prefetch" href="/assets/js/103.b91c2e2b.js"><link rel="prefetch" href="/assets/js/104.6f90f799.js"><link rel="prefetch" href="/assets/js/105.73780a6e.js"><link rel="prefetch" href="/assets/js/106.e8737813.js"><link rel="prefetch" href="/assets/js/107.5f785c2c.js"><link rel="prefetch" href="/assets/js/108.74958d5b.js"><link rel="prefetch" href="/assets/js/109.d3005515.js"><link rel="prefetch" href="/assets/js/11.32340e89.js"><link rel="prefetch" href="/assets/js/110.65860f7f.js"><link rel="prefetch" href="/assets/js/111.d91c32b6.js"><link rel="prefetch" href="/assets/js/112.a5e8efc2.js"><link rel="prefetch" href="/assets/js/113.191ff9e1.js"><link rel="prefetch" href="/assets/js/114.eb21d1d8.js"><link rel="prefetch" href="/assets/js/115.ed058567.js"><link rel="prefetch" href="/assets/js/116.c73d4a79.js"><link rel="prefetch" href="/assets/js/117.c1195019.js"><link rel="prefetch" href="/assets/js/118.b2aeca16.js"><link rel="prefetch" href="/assets/js/119.666dc6c6.js"><link rel="prefetch" href="/assets/js/12.f3209147.js"><link rel="prefetch" href="/assets/js/120.548bb39a.js"><link rel="prefetch" href="/assets/js/121.d6368bb6.js"><link rel="prefetch" href="/assets/js/122.14d59fae.js"><link rel="prefetch" href="/assets/js/123.7e5e4cc0.js"><link rel="prefetch" href="/assets/js/124.a9c9fc37.js"><link rel="prefetch" href="/assets/js/125.2de4a8c4.js"><link rel="prefetch" href="/assets/js/126.6d029a58.js"><link rel="prefetch" href="/assets/js/127.3f37c3d9.js"><link rel="prefetch" href="/assets/js/128.3bab5bc7.js"><link rel="prefetch" href="/assets/js/129.fde4fcbb.js"><link rel="prefetch" href="/assets/js/13.ff905545.js"><link rel="prefetch" href="/assets/js/130.21002715.js"><link rel="prefetch" href="/assets/js/131.e261ff32.js"><link rel="prefetch" href="/assets/js/132.f4df11c1.js"><link rel="prefetch" href="/assets/js/133.3082ed5c.js"><link rel="prefetch" href="/assets/js/134.f583893d.js"><link rel="prefetch" href="/assets/js/135.4930a3bf.js"><link rel="prefetch" href="/assets/js/136.088fe073.js"><link rel="prefetch" href="/assets/js/137.3b78020c.js"><link rel="prefetch" href="/assets/js/138.19b200da.js"><link rel="prefetch" href="/assets/js/139.890d6075.js"><link rel="prefetch" href="/assets/js/14.c3568dfc.js"><link rel="prefetch" href="/assets/js/140.5b795da9.js"><link rel="prefetch" href="/assets/js/141.15c2c5e7.js"><link rel="prefetch" href="/assets/js/142.c336f1c2.js"><link rel="prefetch" href="/assets/js/143.0eba62e9.js"><link rel="prefetch" href="/assets/js/144.556773e6.js"><link rel="prefetch" href="/assets/js/15.7af482c3.js"><link rel="prefetch" href="/assets/js/16.1add91f2.js"><link rel="prefetch" href="/assets/js/17.5211db13.js"><link rel="prefetch" href="/assets/js/18.cb58294e.js"><link rel="prefetch" href="/assets/js/19.3f4c86e4.js"><link rel="prefetch" href="/assets/js/20.f6e9413a.js"><link rel="prefetch" href="/assets/js/21.d3127fc5.js"><link rel="prefetch" href="/assets/js/22.75a3675d.js"><link rel="prefetch" href="/assets/js/23.4cc8500e.js"><link rel="prefetch" href="/assets/js/24.6e9f6fde.js"><link rel="prefetch" href="/assets/js/25.59ab9b92.js"><link rel="prefetch" href="/assets/js/26.b6ea8fe3.js"><link rel="prefetch" href="/assets/js/27.eb622419.js"><link rel="prefetch" href="/assets/js/28.82216df1.js"><link rel="prefetch" href="/assets/js/29.aca5231f.js"><link rel="prefetch" href="/assets/js/3.cc8f990c.js"><link rel="prefetch" href="/assets/js/30.b0c74906.js"><link rel="prefetch" href="/assets/js/31.41b824b5.js"><link rel="prefetch" href="/assets/js/32.95d89f8c.js"><link rel="prefetch" href="/assets/js/33.7387a515.js"><link rel="prefetch" href="/assets/js/34.3fa9be34.js"><link rel="prefetch" href="/assets/js/35.905a5d0a.js"><link rel="prefetch" href="/assets/js/36.d7ce4b9a.js"><link rel="prefetch" href="/assets/js/37.fd8aaeb0.js"><link rel="prefetch" href="/assets/js/38.b36232f9.js"><link rel="prefetch" href="/assets/js/39.ae371aa8.js"><link rel="prefetch" href="/assets/js/4.b6f813b6.js"><link rel="prefetch" href="/assets/js/40.9e77645d.js"><link rel="prefetch" href="/assets/js/41.7aced1a6.js"><link rel="prefetch" href="/assets/js/42.3431685d.js"><link rel="prefetch" href="/assets/js/43.3c61b623.js"><link rel="prefetch" href="/assets/js/44.74706cc8.js"><link rel="prefetch" href="/assets/js/45.6deb7af6.js"><link rel="prefetch" href="/assets/js/46.51a84a36.js"><link rel="prefetch" href="/assets/js/47.446a6488.js"><link rel="prefetch" href="/assets/js/48.eeb843b8.js"><link rel="prefetch" href="/assets/js/49.f35e84a6.js"><link rel="prefetch" href="/assets/js/5.6c42c548.js"><link rel="prefetch" href="/assets/js/50.39dc3799.js"><link rel="prefetch" href="/assets/js/51.2e98eda6.js"><link rel="prefetch" href="/assets/js/52.0ebf3a07.js"><link rel="prefetch" href="/assets/js/53.7fbd54a4.js"><link rel="prefetch" href="/assets/js/54.42c54b92.js"><link rel="prefetch" href="/assets/js/56.3db642d3.js"><link rel="prefetch" href="/assets/js/57.385f3c0e.js"><link rel="prefetch" href="/assets/js/58.fcb950f6.js"><link rel="prefetch" href="/assets/js/59.b77c39f3.js"><link rel="prefetch" href="/assets/js/6.249f79ed.js"><link rel="prefetch" href="/assets/js/60.4e20518b.js"><link rel="prefetch" href="/assets/js/61.86f57283.js"><link rel="prefetch" href="/assets/js/62.a4fe965c.js"><link rel="prefetch" href="/assets/js/63.c5dbf72b.js"><link rel="prefetch" href="/assets/js/64.f9242d96.js"><link rel="prefetch" href="/assets/js/65.63c88e9b.js"><link rel="prefetch" href="/assets/js/66.fa97a8fa.js"><link rel="prefetch" href="/assets/js/67.9de0f89d.js"><link rel="prefetch" href="/assets/js/68.3959d250.js"><link rel="prefetch" href="/assets/js/69.8d33bb82.js"><link rel="prefetch" href="/assets/js/7.965b9c14.js"><link rel="prefetch" href="/assets/js/70.eae11422.js"><link rel="prefetch" href="/assets/js/71.9dcc9639.js"><link rel="prefetch" href="/assets/js/72.d9858851.js"><link rel="prefetch" href="/assets/js/73.1f5d46fd.js"><link rel="prefetch" href="/assets/js/74.55cfc98d.js"><link rel="prefetch" href="/assets/js/75.1c8f9b5f.js"><link rel="prefetch" href="/assets/js/76.9712797a.js"><link rel="prefetch" href="/assets/js/77.fc4c4708.js"><link rel="prefetch" href="/assets/js/78.9e58022f.js"><link rel="prefetch" href="/assets/js/79.8958c264.js"><link rel="prefetch" href="/assets/js/80.25f206a9.js"><link rel="prefetch" href="/assets/js/81.82b297fd.js"><link rel="prefetch" href="/assets/js/82.95a92348.js"><link rel="prefetch" href="/assets/js/83.1d856c8a.js"><link rel="prefetch" href="/assets/js/84.2fe27c01.js"><link rel="prefetch" href="/assets/js/85.119d769d.js"><link rel="prefetch" href="/assets/js/86.dda9549d.js"><link rel="prefetch" href="/assets/js/87.5f96db0f.js"><link rel="prefetch" href="/assets/js/88.09fc8a79.js"><link rel="prefetch" href="/assets/js/89.86b4ddcb.js"><link rel="prefetch" href="/assets/js/90.85df2a8a.js"><link rel="prefetch" href="/assets/js/91.593d62b4.js"><link rel="prefetch" href="/assets/js/92.1f4f1612.js"><link rel="prefetch" href="/assets/js/93.3cf32b8f.js"><link rel="prefetch" href="/assets/js/94.ddb588cb.js"><link rel="prefetch" href="/assets/js/95.850c9613.js"><link rel="prefetch" href="/assets/js/96.5e20d25c.js"><link rel="prefetch" href="/assets/js/97.41935f73.js"><link rel="prefetch" href="/assets/js/98.9c3b2db4.js"><link rel="prefetch" href="/assets/js/99.6c498302.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4849e3bc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b0fbd704.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">扎星的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS数组</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS编程练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS常见设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS高阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6新特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>性能优化</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/performance/guide/" class="sidebar-link">001前端性能优化知识体系导读</a></li><li><a href="/performance/webpack/" class="sidebar-link">002webpack性能调优与gzip原理</a></li><li><a href="/performance/picture/" class="sidebar-link">003图片优化</a></li><li><a href="/performance/cache/" class="sidebar-link">004浏览器缓存机制和策略</a></li><li><a href="/performance/storage/" class="sidebar-link">005浏览器本地存储</a></li><li><a href="/performance/rendering/" class="sidebar-link">006服务端渲染的探索与实践</a></li><li><a href="/performance/operating/" class="sidebar-link">007浏览器运行机制</a></li><li><a href="/performance/DOM/" class="sidebar-link">008DOM优化原理与基本实践</a></li><li><a href="/performance/eventloop/" class="sidebar-link">009Event Loop 与异步更新策略</a></li><li><a href="/performance/reflow&amp;repaint/" aria-current="page" class="active sidebar-link">010回流和重绘</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/performance/reflow&amp;repaint/#哪些实际操作会导致回流与重绘" class="sidebar-link">哪些实际操作会导致回流与重绘</a></li><li class="sidebar-sub-header"><a href="/performance/reflow&amp;repaint/#如何规避回流与重绘" class="sidebar-link">如何规避回流与重绘</a></li><li class="sidebar-sub-header"><a href="/performance/reflow&amp;repaint/#flush-队列-浏览器并没有那么简单" class="sidebar-link">Flush 队列：浏览器并没有那么简单</a></li></ul></li><li><a href="/performance/debounce&amp;throttle/" class="sidebar-link">011防抖和节流</a></li><li><a href="/performance/performanceAPI/" class="sidebar-link">012性能检测篇: PerformanceAPI</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>V8引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>异步I/O和异步编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TCP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP协议</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="回流和重绘"><a href="#回流和重绘" class="header-anchor">#</a> 回流和重绘</h1> <ul><li><p>回流：当我们对 DOM 的修改引发了 DOM 几何尺寸的变化（比如修改元素的宽、高或隐藏元素等）时，浏览器需要重新计算元素的几何属性（其他元素的几何属性和位置也会因此受到影响），然后再将计算的结果绘制出来。这个过程就是回流（也叫重排）。</p></li> <li><p>重绘：当我们对 DOM 的修改导致了样式的变化、却并未影响其几何属性（比如修改了颜色或背景色）时，浏览器不需重新计算元素的几何属性、直接为该元素绘制新的样式（跳过了上图所示的回流环节）。这个过程叫做重绘。</p></li></ul> <p>由此我们可以看出，重绘不一定导致回流，回流一定会导致重绘。硬要比较的话，回流比重绘做的事情更多，带来的开销也更大。但这两个说到底都是吃性能的，所以都不是什么善茬。我们在开发中，要从代码层面出发，尽可能把回流和重绘的次数最小化。</p> <h2 id="哪些实际操作会导致回流与重绘"><a href="#哪些实际操作会导致回流与重绘" class="header-anchor">#</a> 哪些实际操作会导致回流与重绘</h2> <p>要避免回流与重绘的发生，最直接的做法是避免掉可能会引发回流与重绘的 DOM 操作，就好像拆弹专家在解决一颗炸弹时，最重要的是掐灭它的导火索。</p> <p>触发重绘的“导火索”比较好识别——只要是不触发回流，但又触发了样式改变的 DOM 操作，都会引起重绘，比如背景色、文字色、可见性(可见性这里特指形如visibility: hidden这样不改变元素位置和存在性的、单纯针对可见性的操作，注意与display:none进行区分)等。为此，我们要着重理解一下那些可能触发回流的操作。</p> <h3 id="回流的-导火索"><a href="#回流的-导火索" class="header-anchor">#</a> 回流的“导火索”</h3> <ul><li>最“贵”的操作：改变 DOM 元素的几何属性</li></ul> <p>这个改变几乎可以说是“牵一发动全身”——当一个DOM元素的几何属性发生变化时，所有和它相关的节点（比如父子节点、兄弟节点等）的几何属性都需要进行重新计算，它会带来巨大的计算量。</p> <p>常见的几何属性有 width、height、padding、margin、left、top、border 等等。此处不再给大家一一列举。有的文章喜欢罗列属性表格，但我相信我今天列出来大家也不会看、看了也记不住（因为太多了）。我自己也不会去记这些——其实确实没必要记，️一个属性是不是几何属性、会不会导致空间布局发生变化，大家写样式的时候完全可以通过代码效果看出来。多说无益，还希望大家可以多写多试，形成自己的“肌肉记忆”。</p> <ul><li>“价格适中”的操作：改变 DOM 树的结构</li></ul> <p>这里主要指的是节点的增减、移动等操作。浏览器引擎布局的过程，顺序上可以类比于树的层序遍历——它是一个从上到下、从左到右的过程。通常在这个过程中，当前元素不会再影响其前面已经遍历过的元素。</p> <ul><li>最容易被忽略的操作：获取一些特定属性的值</li></ul> <p>当你要用到像这样的属性：offsetTop、offsetLeft、 offsetWidth、offsetHeight、scrollTop、scrollLeft、scrollWidth、scrollHeight、clientTop、clientLeft、clientWidth、clientHeight 时，你就要注意了！</p> <p>“像这样”的属性，到底是像什么样？——这些值有一个共性，就是需要通过即时计算得到。因此浏览器为了获取这些值，也会进行回流。</p> <p>除此之外，当我们调用了 getComputedStyle 方法，或者 IE 里的 currentStyle 时，也会触发回流。原理是一样的，都为求一个“即时性”和“准确性”。</p> <h2 id="如何规避回流与重绘"><a href="#如何规避回流与重绘" class="header-anchor">#</a> 如何规避回流与重绘</h2> <p>了解了回流与重绘的“导火索”，我们就要尽量规避它们。但很多时候，我们不得不使用它们。当避无可避时，我们就要学会更聪明地使用它们。</p> <h3 id="将-导火索-缓存起来-避免频繁改动"><a href="#将-导火索-缓存起来-避免频繁改动" class="header-anchor">#</a> 将“导火索”缓存起来，避免频繁改动</h3> <p>bad:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 获取el元素</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'el'</span><span class="token punctuation">)</span>
  <span class="token comment">// 这里循环判定比较简单，实际中或许会拓展出比较复杂的判定需求</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top  <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetTop  <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
      el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetLeft <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>good:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 缓存offsetLeft与offsetTop的值</span>
<span class="token keyword">const</span> el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'el'</span><span class="token punctuation">)</span> 
<span class="token keyword">let</span> offLeft <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">,</span> offTop <span class="token operator">=</span> el<span class="token punctuation">.</span>offsetTop

<span class="token comment">// 在JS层面进行计算</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  offLeft <span class="token operator">+=</span> <span class="token number">10</span>
  offTop  <span class="token operator">+=</span> <span class="token number">10</span>
<span class="token punctuation">}</span>

<span class="token comment">// 一次性将计算结果应用到DOM上</span>
el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> offLeft <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span>
el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> offTop  <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span>
</code></pre></div><h3 id="避免逐条改变样式-使用类名去合并样式"><a href="#避免逐条改变样式-使用类名去合并样式" class="header-anchor">#</a> 避免逐条改变样式，使用类名去合并样式</h3> <p>比如我们可以把这段单纯的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'200px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'10px solid red'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'red'</span>
</code></pre></div><p>优化成一个有 class 加持的样子：</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.basic_style</span> <span class="token punctuation">{</span>
      <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
      <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>
      <span class="token property">border</span><span class="token punctuation">:</span> 10px solid red<span class="token punctuation">;</span>
      <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span>
    container<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'basic_style'</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>前者每次单独操作，都去触发一次渲染树更改，从而导致相应的回流与重绘过程。</p> <p>合并之后，等于我们将所有的更改一次性发出，用一个 style 请求解决掉了。</p> <h3 id="将-dom-离线"><a href="#将-dom-离线" class="header-anchor">#</a> 将 DOM “离线”</h3> <p>我们上文所说的回流和重绘，都是在“该元素位于页面上”的前提下会发生的。一旦我们给元素设置 display: none，将其从页面上“拿掉”，那么我们的后续操作，将无法触发回流与重绘——这个将元素“拿掉”的操作，就叫做 DOM 离线化。</p> <p>仍以我们上文的代码片段为例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'200px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'10px solid red'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'red'</span>
<span class="token operator">...</span>（省略了许多类似的后续操作）
</code></pre></div><p>离线化后就是这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'200px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'10px solid red'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'red'</span>
<span class="token operator">...</span>（省略了许多类似的后续操作）
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span>
</code></pre></div><p>有的同学会问，拿掉一个元素再把它放回去，这不也会触发一次昂贵的回流吗？这话不假，但我们把它拿下来了，后续不管我操作这个元素多少次，每一步的操作成本都会非常低。当我们只需要进行很少的 DOM 操作时，DOM 离线化的优越性确实不太明显。但是一旦操作频繁起来，这“拿掉”和“放回”的开销都将会是非常值得的。</p> <h2 id="flush-队列-浏览器并没有那么简单"><a href="#flush-队列-浏览器并没有那么简单" class="header-anchor">#</a> Flush 队列：浏览器并没有那么简单</h2> <p>以我们现在的知识基础，理解上面的优化操作并不难。那么现在我问大家一个问题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'200px'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>border <span class="token operator">=</span> <span class="token string">'10px solid red'</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token string">'red'</span>
</code></pre></div><p>这段代码里，浏览器进行了多少次的回流或重绘呢？</p> <p>“width、height、border是几何属性，各触发一次回流；color只造成外观的变化，会触发一次重绘。”——如果你立刻这么想了，说明你是个能力不错的同学，认真阅读了前面的内容。那么我们现在立刻跑一跑这段代码，看看浏览器怎么说：</p> <p><img src="data:image/jpeg;base64,UklGRsQSAABXRUJQVlA4ILgSAACQcgCdASoABWAAPpFGn0slo6Mho7IZ4LASCWdu4W5w3IeahueUVa2x/gPUB5gHjGepHzAea9/yP2x9w/RE+o56FP7EenN7I397/8vpX6rL58/sna7/dvyq6+L2J7feqTmD6ItTj499jPyn9k9C/834a+oz1AvWX+z3zUAH6N/Zu/Z1WfYb7//y/cA/lv7lepffo0EfEh/7v816MPqX/0/6T4Ff1/65IypFNBIfTcxAPGw1Hq9a2UITIWiNxAwcflqlTi6Eqb5F9L486k8JPLPlD5J4vg0GcUreZ3p1HHT34ZBv3XmOOnOcM2MQlSK3g54vV0Oqi9eLnF/VERL+Lb78uOTaFIqte3puB/vSDCj8YGVwEwkZfN9zwD8NJYoW4/Zj1VVVSbCKD6ou9pZwYfML/M1xt4BBuFWSvSIHmEbjwU67L/qtPsmD6kj29I1VVVVTWjHOx83R1abshHC2KKjfM6Jl6IsbUVHSIvKt2h/FP5N8HUtWH/dBeFNt3d3gF3d3d3iEPGCOkMhX2vWV5qSJ5Pzr5zL+UPaw6B40ZoOXIoA/efMtJLqPPTp2lHl9U5iwPdenJLgaLMzM2hw3iFDtH8FcdsG2XKfk+eMX90yngBMciDf0nkJAoiRVa03XHsVqjxJDvDacOKcSWKqsRMZmZmZukm7u7vKewDVWetXHpvu/8c7V3RdziURH5QK40x7j8I6k1ODO50qyZP/9xEaxbFczs2riWG4HVFoaeOaGLigf8aJNuojUUPKBX7DQ0wpPDecoUeU5bmcXvWkRfqAhRpmVgzp+TGz0DORYWKqsuBERERFb8liqqqw2qqqqq9sJGIIAVpSB6TIjS+AASJh/vq5JlyBDzWiX8b9xB2nIqFPhK6vM+aiaOd5N5wr7sHVelg8XGHamAb2Bod5tKhi6dMI+vhaNfKdp69gaWofg4CWpYm6tcD+Ya9n0MznY2TuYAj3qq4xmZmZm6Sbu7u8+A7u7u71N3d3d3sYAAAAAhTezOfdXlxaBFDE5Ly7qXJI9HUx56d523qml/nzSV+LA8fAjCFAqF/7L9IhQxX4aMLBi1y49tmviCN0zYdCjrMmKznmXuAMh+PSQ+qBGzwL2FpD+C2ZqHoto0IO+B/7msWrOL3PZpKMHuYs9CZrpWrSUYPZpHl8wPcxaUHGV1q38YPcxaTcW2UsPcllyvFd4QtQ9jKrVQIoB8nsYR1tQmR0ftnH7aQYOBm/P1PjgAP7h/otgY5MkuGZQKhIzZ0BCfSz+ck5v1Wdd7M/wh858HSB92vHInd/VmqDpvMUS0NESh5NFdNELrR7F0cYphaNNXmyywzxjSRbOuWvJn9yvMI641eo14lZGsvg5GZykcFAhU9KqlzpbTMT2fgdaNO9M8edTV51tf/66gXW59/DwbsIDDBfR6jkeQPJ1Mx2yCmTz0tFJhyaqTeNFYwuCs3vqQaHIneK4NeJ3tPqt+jZj4xURlgZ5Zaps2402KQCi/hMh/4okA5XO5FvhB/wPd/LnuAbhvaAzJacXqR4XR2h6pQZjcNRZRJRr4ITmPqL71WkzyOW/937lKaxQKXMNFrfGSychUZDRHQLo+xP120+4Ho+2SkaOQQrqh4apxsZO5Of66zN/Ly6gkUoVjOH+iJfEVs/1imP09h2eQIUjBJ+36oNhkTHFgIUeLUHTS3KIdy7ZY6PWdKMAy5jU3sZz6YNUajyfJbBGvyU/2KuUan8IvPfWs8+MWZZnBeTjAlXPkqi/3ZjX/Eo8WpgiXVn2a+rgk2uULptwp7sIIIt6MJCwFzcx0X8T8zWOTnbTQYKOErJJVCSRIa8kqmeRS70zDTfr87oOy/jvC2j7jp7S73v1fQpjvPSQAbG37CsvdwtoaKPs2m1dkTgwfwwG2VbSxG0UOh6IKX04fQGABJ78GYChz2IYS/ra/qqyIyBnwd0MVY1krtmcZVceukUfeLADv5y66WLVx5KcdmwhdjdOt8veOu+mZha3H4qthDuhkrIaeAsFW/q3k8zOI/TEsrYslX+Vg6+HquDSKzgJ4P1Xuh+aD/uxU8Q66yg96omdX8IL5sY/jieNIpDsYVS1rTMj6lHXj01hNARixlrsKBcfBfeC1FdY+bcwXVDqjGoO020X561L5GHUX2yfCnFbD3m6mKCSYnbjnM9PNpw/avL6iAo0BD1u5xyMQxtYBhC+tcuXsjFAXvMS0dOj3ZiKU7V8DjieNVBQRDOSaLbAiePr5DzLqtxi/sw2qgW80I+UgvUYgzSj4gN9iSDAW1QJTkzGqXlHgdGuyNX5lFisq/7ILVe/cfImNA6Vvy2wbLrWYXCRLuFKmxKRosjQ1/cuRnmTIfEs+JVtQJmkDI1+9fvoM31Hi1B0vspHmeuq2iQRBkHTxx7fIaMa8fOXqEpLCiD10ENmWYYipjguJsDV7CId4RMx+bdfTZIWjSHreJOl/+7yxXg/Jf/imOzRwxQhk26tLbqDYvSgqLijYvSgqLiwZvTl0QzfYj7ZnI8Lrddr8KofD+YLBb8XcbjGIdDtPlIjaTxRV4cm+KEQ6oln9n+7pNNfrJp1+CfTAALDo8mGW3//zMe8JA24NHqnAljaKvxGDAnae4Cfa2bkBadCNfU4YJo7NH9pTRzjI6TNFBYzfCb+vYO7hBS5sNbmv8iee4BG59/+HBr12YjQfBS9Mg26I+JJPyLfqtLveZm11UE3IiE/1PCfkLMHHT5PdDaY6qHUcxkOWUJYh02b/i8HEIJ5GcZr2nmLRRRSqwdIKkJZO4rxYfEAWAPObmm8RG7ScLzk9bXTQCeU08stIBh538sRyNK4nUG6fBGRHoyz+NjpMBQMBpia95JnI8ilPEhte//fk962Nnl+/7qDHdLoUIcqitcGhZtvCVOGsEyFAt19UYfFjLVBGGeAyHD4RQm0BcwCc76hRJEfVbXOACCiNih7nBjS1KFJO/xfZhGQGQWWbi582yVF5Kx16rqTfoWzlEBOCi6jqcscSTSfjK6xmW8ooXQmxN3WhnP+ybcUTssSxYaSdRjXcuQB6RSlXILtw5MXi+lJF6QMWkoKGeDsZJyFBMLLzj7TsU+BFR+/vPzgOMclOc1MPM2/QdBrFA4p3tjdX3XEz+Z6zYzl+LGOh/3yopf+7SjIGSI8/KanuTsGm3UDaFjT5m4VUmVrTGhzyhRQSUn7/h/h7u0LVhdnmDMj19XYp6qfphVqk/fVcbDwLYIAdO5AxQt7tn2OzFhOxxR4jjQ5dgwOQ+fzvh6G9mJUuUVEDwHgOAQxuXy3t1+9BlLW+C7NpeAWmXh5o3JrFJ7WpCpema9KnkcuVAFTNxtusYE4Jsb6m7wK6Iwg3QFZZUqPV2hCJCn23YlqdLs+Lsz74b2gj8NsjwvS8BP8obdoUHgd+yvSxxF357mtCUd4RUxUk0l/0qE4x52uf6QNehAbSgcjqw41Yb1js1Ps58H6ge+7X8ureKnFXeSQPIdeIc9bQbTmTuorVxEnEhwjg3rtYDPGV1+2AIUAA/BbSnPG/SrX3ffF4RLvzFb/mQEtZYkeN2YE7Wc0xc0HUFWW3lw9D+v0T94VDRA785sO5qK+5tH4jzdz386hzxCoCsB5SYpitxDtj5n3aYZaUp+KkpC9FeNGnY2ceUQJ6OwvUhJKK2Z7tIL4CRIJvocHLIkhFYKZhbPOk8gPfdv6gpdj2mfGJwtEx4LhUbbyrGNi93DOTGeWYb3qJuYeIZJqoAmDlaqAQXj2gfymqjMmXSAAAAF4ykh2WYc8sGRyRDffcIpJC2D+FcuuzhHJ19YbnVBXkb0VVNfmQhH9/WEQNm8hPhsAEgxeKdbvnRRdSWtxHr/eaS6AsPyLGbJO5ZNQkmkV7HbQWNApDPSTuLRLP/arZsgVCIjtyTFSYodIDa9mMrRrcPizH+co/BRR/d43B4c2Dl8ya0BEBOEyx/YxUHakiMdevxSS+dRH13zOoA5ShcbBx+YLQuoBT5bQSPxCOEkMqL6JBMkytbz63DQp7FNI5WSLrJ+dsiu+6CXVLpclNvdV/sMs8VH1tbuE2nvyet/r2IbRgOHBvzSRVe0GzxJNsdPfuZ6tpbyeidy5COupNvayrl69+ZctHMrDGXA5pOjQPmPQ5QWePxSJOTfFCGzABSXTAuZPfoPw7NaixDoY0B4dWdDFT9MuH1K18HeVZC3XN671en75wPKZtk7sJYMVJa5SxMjFlngg92ZU0dSmEbHGdyvssABUkAAAAAAD5cUYggzImqLLBGKTpBIGa3NrFGCY6ml0hApRO4HxLnjVVieSNeWuqMvXLqf4aMg59BqklownDxjXUwJQHiCtN3FgfiwcJSvcdfY0dTPsK4rLk8uxnOKVFZ8h0vdagPP1oXjLX9Rek60eiLfZH9DFZuGi6AWdV2Vr8XzNDytycHYqncWcn6Nb+Dpu6TU4CG4Tko7jwpog09uWDwM5rYw6LwdJa5WffLKFfwbuYu/4tXSoxu2YJq2dGsb7C4F7ez0aX8RFTgutqYd5wtOTKHGAz0tzOF6VTxQ9YcMG1Na6G8aZoGAzSPYtn3aWDgQRCcd6nwzJEYvWvGqf+lhnbVcuj+VwSxMufJEa/K4EUxf9UDj2bGOELVCopvTClj5tecPSPun9UyIaqeWcmJhISMteaBGm+GIFyhAIv7umfjOIFA/t1KFZwbo79exPIWRA0HWJNOP0fK6hQsf0SeXTd4nIGAEIX3gSOv+87nq8Bvmceevglyj5RHYZyfURj3u+r3vhZUkGapvVQTzOs30SobJ+xulLcK/tQfw4VGq7wUgVrl+MqrWKR7LBgxgSsxlquabl8XTb2NW95jNfaJP3L8p3F+Hm2oWDlhMMSGV+3GDcgBqHSCp0204zBz4Koc2/wjdbge7XWSEF0c2ZfE3NqF/bmy55QDbuaK0FS+LEWh/OZW0/SrGc9MHORYJ2ZG5P3M4FzLa8SIkAZXAcEeZjVKBZEe+spSFVR1dhfq4MbPjRKRVNg8DRaYiv/FE9k2/gMJGKSCF8I/yOLY6Mm5UjQdX1I0KTDLYvZ0cF+PsV8ZsFaP30V3IAllbsrj4JSRV9JSof/6fxKhcTDyBJibMal7djCAM/FGwOEoPOPcd4Icggho4MtZXuj8/PFwLbvn+dWTWlUj8H0Enwn8PgQ2yALrQuddRd6YvM4F0PrYA5VI+4jU5Zr0prMxIsk1uapvBx/1hzt+rvYju9rhOPHOuRO7o75Zqb5L/N2Eys22+z/eN9QfWrMl/PIFEL2La98l509VlRnjmH+EdSzcvGi/abQV4gk7BQGpkX7T1+FvfDmnPFzjFPkPgNtIpgXHwkAAAAAAAACGEVpi6v8FjGKdHPaZ7FO1WbcwVcesKuTdg+t8S8LboMt/cZ7pHrOzUVq83JBQ+rpKZ1lM7mgG7KeiJwfirP1m2TXz7qmwz202avbvJrCQx3OZhwxZTgjvfNMflIfDoCqQibWwlAt/btktz9EUy6mU/e/y0/1UK1L9UrBJ6+Z8SCqrtnkyhrXSoz2Jvx1Nk+YgzJeLKwKWtppdbqFKz0gUKUHNCfomG/gD5c9DZZzYMQDm/VALrqPzfFNyyq/zeRTuwa5ddscL4lNF7/c01y65BNpM2dhcRrGIer2vjnzEc8Cq8JRnULTpuuwUTpXZ8gMkg2dmUJl/q500D4IoO3givbLNhFBOTqBIuRHfLeNREjj6F0r/HfN3PDp8tGAFKYtMhE1Ua0Ksrjj6kod/VzU2AkZUV2C4Xod+xn4onWjPIyVQ+QZGD+vjVRpyPcKgxcCyEOtMpZVhYsuG6ncI79R8mEFGk6QvbzkQQD+GXjUoYMjSRMGNeAV2ZFeZskb79N+6p8nUrWL2+ILZd0rqpd5g2VVAH/Q3M/Nzw+L1UneKoZkoC33YkjgnFYQcZhb+CJLOVuIziBoJ6WDS5K3pge7wCBJ98BPWEmnWYp5UJpK2EWyZcKvVSB1U96s2kFqmkDPZdv6jdzDZFpJ+a2+jsjOhWl0TEIroEMTu6t5MCX1XzPvHbWdBo7wP32d+MVgufhgB1mqhksRqfgy7JFmxP8VtVki/2vjneFabG1rRfcRMa/88mFnTsw3sAAKpWXeb2Asp6V4kH/EwMMMUyC/sPSPFKU47L25BW4LsEvRSlyemo0yrkAXdid/WHZOB7qv4PuO+dTqgVrfowwEmINmhqjR84/n+3lhdzWRMvK8JlVRvL3Xw/cdGSreKhxS3fjxf3HF52/hcPVRB5zCpddynCv7+ZdY1qj+HdrBXH+6+EDW0XLkJn6DhtLUfDMAaDfOchfXCz0Lqha2v64i5ETAkPNioZvNuWxfzKRcgD942KlaAK78Zqt8z6JlLS0CqjAR15juOo6CzEosiFgbyIIW+gQH3OlFAaJX++O3IZ5KD7RGAAA" alt=""></p> <p>这里为大家截取有“Layout”和“Paint”出镜的片段（这个图是通过 Chrome 的 Performance 面板得到的，后面会教大家用这个东西）。我们看到浏览器只进行了一次回流和一次重绘——和我们想的不一样啊，为啥呢？</p> <p>因为现代浏览器是很聪明的。浏览器自己也清楚，如果每次 DOM 操作都即时地反馈一次回流或重绘，那么性能上来说是扛不住的。于是它自己缓存了一个 flush 队列，把我们触发的回流与重绘任务都塞进去，待到队列里的任务多起来、或者达到了一定的时间间隔，或者“不得已”的时候，再将这些任务一口气出队。因此我们看到，上面就算我们进行了 4 次 DOM 更改，也只触发了一次 Layout 和一次 Paint。</p> <p>大家这里尤其小心这个“不得已”的时候。前面我们在介绍回流的“导火索”的时候，提到过有一类属性很特别，它们有很强的“即时性”。当我们访问这些属性时，浏览器会为了获得此时此刻的、最准确的属性值，而提前将 flush 队列的任务出队——这就是所谓的“不得已”时刻。具体是哪些属性值，我们已经在“最容易被忽略的操作”这个小模块介绍过了，此处不再赘述。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/performance/eventloop/" class="prev">
        009Event Loop 与异步更新策略
      </a></span> <span class="next"><a href="/performance/debounce&amp;throttle/">
        011防抖和节流
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7faaeb90.js" defer></script><script src="/assets/js/2.4ceac094.js" defer></script><script src="/assets/js/1.06e97743.js" defer></script><script src="/assets/js/55.1c372827.js" defer></script>
  </body>
</html>
